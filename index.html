<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>WorkHub</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<style>
:root{--bg:#f5f6fa;--surface:#fff;--primary:#4F46E5;--primaryLight:#E0E7FF;--primaryDark:#3730A3;--text:#1e1e2d;--textSec:#6b7280;--border:#e5e7eb;--success:#10B981;--warning:#F59E0B;--danger:#EF4444;--radius:12px;--shadow:0 1px 3px rgba(0,0,0,.08);--shadowMd:0 4px 12px rgba(0,0,0,.1);--font:'Inter',sans-serif}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);overflow-x:hidden}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes spin{to{transform:rotate(360deg)}}
.toast-wrap{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;background:var(--text);color:#fff;border-radius:var(--radius);font-size:13px;animation:slideDown .3s ease;box-shadow:var(--shadowMd);max-width:320px}
.toast.success{background:var(--success)}.toast.error{background:var(--danger)}

/* LOGIN */
.login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
.login-card{background:#fff;border-radius:20px;padding:48px 40px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.15);max-width:400px;width:90%}
.login-card h1{font-size:28px;margin-bottom:8px;color:var(--text)}
.login-card p{color:var(--textSec);margin-bottom:32px;font-size:14px}
.g-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 24px;background:#fff;border:2px solid var(--border);border-radius:var(--radius);font-size:15px;font-weight:500;cursor:pointer;transition:.2s}
.g-btn:hover{border-color:var(--primary);background:var(--primaryLight)}

/* HEADER */
.header{height:60px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 24px;position:fixed;top:0;left:0;right:0;z-index:100;box-shadow:var(--shadow)}
.header .logo{font-size:20px;font-weight:700;color:var(--primary);margin-right:32px;white-space:nowrap}
.header .search-box{flex:1;max-width:400px;position:relative}
.header .search-box input{width:100%;padding:8px 16px 8px 36px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;outline:none;transition:.2s}
.header .search-box input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}
.header .search-box svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--textSec)}
.hdr-right{margin-left:auto;display:flex;align-items:center;gap:16px}
.hdr-right .avatar{width:36px;height:36px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;cursor:pointer}

/* SIDEBAR */
.sidebar{position:fixed;top:60px;left:0;bottom:0;width:240px;background:var(--surface);border-right:1px solid var(--border);padding:16px 0;z-index:90;transition:transform .3s ease;overflow-y:auto}
.sidebar.collapsed{transform:translateX(-100%)}
.sb-item{display:flex;align-items:center;gap:12px;padding:10px 24px;color:var(--textSec);font-size:14px;cursor:pointer;transition:.15s;text-decoration:none;border-left:3px solid transparent}
.sb-item:hover{background:var(--primaryLight);color:var(--primary)}
.sb-item.active{color:var(--primary);background:var(--primaryLight);font-weight:600;border-left-color:var(--primary)}
.sb-label{padding:16px 24px 8px;font-size:11px;text-transform:uppercase;color:var(--textSec);letter-spacing:1px;font-weight:600}

/* MAIN */
.main{margin-left:240px;margin-top:60px;padding:24px;min-height:calc(100vh - 60px);transition:margin-left .3s ease}
.main.expanded{margin-left:0}
.page{display:none;animation:fadeIn .3s ease}
.page.active{display:block}

/* CARDS */
.card{background:var(--surface);border-radius:var(--radius);padding:24px;box-shadow:var(--shadow);margin-bottom:20px;border:1px solid var(--border);transition:.2s}
.card:hover{box-shadow:var(--shadowMd)}
.card-title{font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--surface);border-radius:var(--radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow)}
.stat-card .stat-num{font-size:28px;font-weight:700;color:var(--primary)}
.stat-card .stat-label{font-size:12px;color:var(--textSec);margin-top:4px}

/* BUTTONS */
.btn{padding:8px 16px;border-radius:var(--radius);font-size:13px;font-weight:500;border:none;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primaryDark)}
.btn-secondary{background:var(--primaryLight);color:var(--primary)}.btn-secondary:hover{background:#c7d2fe}
.btn-danger{background:#FEE2E2;color:var(--danger)}.btn-danger:hover{background:#FECACA}
.btn-success{background:#D1FAE5;color:var(--success)}.btn-success:hover{background:#A7F3D0}
.btn-sm{padding:6px 12px;font-size:12px}

/* FORM */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:6px;color:var(--text)}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;font-family:var(--font);outline:none;transition:.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.1)}

/* TABLE */
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl th{text-align:left;padding:10px 12px;background:var(--bg);font-weight:600;color:var(--textSec);font-size:11px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
.tbl td{padding:10px 12px;border-bottom:1px solid var(--border)}
.tbl tr:hover{background:var(--primaryLight)}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border-radius:16px;padding:28px;max-width:500px;width:92%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:fadeIn .2s ease}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-header h3{font-size:18px;font-weight:600}
.modal-close{width:32px;height:32px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:.15s}
.modal-close:hover{background:var(--danger);color:#fff}

/* BADGE */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge-blue{background:var(--primaryLight);color:var(--primary)}
.badge-green{background:#D1FAE5;color:var(--success)}
.badge-red{background:#FEE2E2;color:var(--danger)}
.badge-yellow{background:#FEF3C7;color:var(--warning)}

/* DINING */
.dn-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
.dn-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;cursor:pointer;transition:.2s;position:relative;overflow:hidden}
.dn-card:hover{transform:translateY(-2px);box-shadow:var(--shadowMd)}
.dn-card .dn-emoji{font-size:36px;margin-bottom:12px}
.dn-card .dn-name{font-size:15px;font-weight:600;margin-bottom:4px}
.dn-card .dn-desc{font-size:12px;color:var(--textSec)}

/* CALENDAR */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.cal-header h3{font-size:18px;font-weight:600}
.cal-nav{display:flex;align-items:center;gap:12px}
.cal-nav button{width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:.15s}
.cal-nav button:hover{background:var(--primaryLight);color:var(--primary)}
.cal-nav .cal-month{font-size:16px;font-weight:600;min-width:140px;text-align:center}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day-header{padding:8px 4px;text-align:center;font-size:11px;font-weight:600;color:var(--textSec);text-transform:uppercase}
.cal-day{min-height:80px;padding:6px;border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:.15s;background:var(--surface);position:relative}
.cal-day:hover{background:var(--primaryLight)}
.cal-day.today{border-color:var(--primary);background:rgba(79,70,229,.04)}
.cal-day.other-month{opacity:.35}
.cal-day .day-num{font-size:12px;font-weight:600;margin-bottom:2px}
.cal-day.today .day-num{color:var(--primary)}
.cal-day .day-num.sun{color:var(--danger)}
.cal-day .day-num.sat{color:var(--primary)}
.cal-event{font-size:10px;padding:2px 4px;border-radius:4px;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;color:#fff;font-weight:500}
.cal-event.ev-blue{background:#4F46E5}.cal-event.ev-green{background:#10B981}.cal-event.ev-red{background:#EF4444}.cal-event.ev-yellow{background:#F59E0B;color:#000}
.cal-event-more{font-size:10px;color:var(--primary);font-weight:600;cursor:pointer}
.cal-auth-box{text-align:center;padding:40px;background:var(--bg);border-radius:var(--radius);border:2px dashed var(--border)}
.cal-auth-box p{margin-bottom:16px;color:var(--textSec);font-size:14px}

/* CHATBOT */
.cb-btn{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--primary);color:#fff;border:none;cursor:pointer;box-shadow:0 4px 16px rgba(79,70,229,.4);font-size:24px;z-index:150;transition:.2s}
.cb-btn:hover{transform:scale(1.1)}
.cb-panel{display:none;position:fixed;bottom:90px;right:24px;width:380px;max-height:500px;background:var(--surface);border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);z-index:150;flex-direction:column;overflow:hidden;border:1px solid var(--border)}
.cb-panel.open{display:flex}
.cb-head{padding:16px;background:var(--primary);color:#fff;font-weight:600;display:flex;align-items:center;justify-content:space-between}
.cb-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px;max-height:340px}
.cb-msg{max-width:85%;padding:10px 14px;border-radius:12px;font-size:13px;line-height:1.5;word-break:break-word}
.cb-msg.bot{background:var(--bg);align-self:flex-start;border-bottom-left-radius:4px}
.cb-msg.user{background:var(--primary);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.cb-input{display:flex;padding:12px;border-top:1px solid var(--border);gap:8px}
.cb-input input{flex:1;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius);font-size:13px;outline:none}
.cb-input button{padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius);cursor:pointer;font-size:13px}

/* RESPONSIVE */
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.mobile-open{transform:translateX(0)}
.main{margin-left:0!important}
.header .search-box{display:none}
.cb-panel{width:calc(100% - 32px);right:16px;bottom:80px}
.stats-grid{grid-template-columns:1fr 1fr}
.cal-day{min-height:50px}
.cal-event{display:none}
.cal-day .day-num{font-size:11px}
}
</style>
</head>
<body>
<div class="toast-wrap" id="toastWrap"></div>

<!-- LOGIN -->
<div class="login-page" id="pgLogin">
<div class="login-card">
<h1>WorkHub</h1>
<p>ì—…ë¬´ ê´€ë¦¬ í”Œë«í¼ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>
<button class="g-btn" onclick="App.auth.login()">
<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
</button>
</div>
</div>

<!-- APP -->
<div id="appShell" style="display:none">
<header class="header">
<button onclick="App.ui.toggleSidebar()" style="background:none;border:none;cursor:pointer;margin-right:12px;font-size:20px">â˜°</button>
<div class="logo">WorkHub</div>
<div class="search-box">
<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
<input type="text" id="globalSearch" placeholder="ê²€ìƒ‰..." onkeyup="App.ui.search(event)">
</div>
<div class="hdr-right">
<div class="avatar" id="hAvatar" onclick="App.auth.logout()" title="ë¡œê·¸ì•„ì›ƒ">W</div>
</div>
</header>

<nav class="sidebar" id="sidebar">
<div class="sb-label">ë©”ë‰´</div>
<a class="sb-item active" data-pg="pgDash" onclick="App.rt.go('pgDash')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
<a class="sb-item" data-pg="pgNotices" onclick="App.rt.go('pgNotices')">ğŸ“‹ ê³µì§€ì‚¬í•­</a>
<a class="sb-item" data-pg="pgDining" onclick="App.rt.go('pgDining')">ğŸ½ï¸ íšŒì‹ ì°¾ê¸°</a>
<a class="sb-item" data-pg="pgDiningLog" onclick="App.rt.go('pgDiningLog')">ğŸ“’ íšŒì‹ ê¸°ë¡</a>
<a class="sb-item" data-pg="pgCalendar" onclick="App.rt.go('pgCalendar')">ğŸ“… ìº˜ë¦°ë”</a>
</nav>

<main class="main" id="mainContent">

<!-- DASHBOARD -->
<div class="page active" id="pgDash">
<h2 style="margin-bottom:20px">ëŒ€ì‹œë³´ë“œ</h2>
<div class="stats-grid" id="dashStats"></div>
<div class="card"><div class="card-title">ìµœê·¼ ê³µì§€ì‚¬í•­</div><div id="dashNotices"></div></div>
<div class="card"><div class="card-title">ìµœê·¼ íšŒì‹ ê¸°ë¡</div><div id="dashDining"></div></div>
</div>

<!-- NOTICES -->
<div class="page" id="pgNotices">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
<h2>ê³µì§€ì‚¬í•­</h2>
<button class="btn btn-primary" onclick="App.notices.openNew()">+ ìƒˆ ê³µì§€</button>
</div>
<div class="card"><table class="tbl"><thead><tr><th>ì œëª©</th><th>ì‘ì„±ì</th><th>ë‚ ì§œ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="noticeList"></tbody></table></div>
</div>

<!-- DINING FINDER -->
<div class="page" id="pgDining">
<h2 style="margin-bottom:20px">íšŒì‹ ì°¾ê¸°</h2>
<div class="card">
<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end">
<div class="form-group"><label>ì§€ì—­</label><select id="selRegion"><option value="">ì„ íƒ</option></select></div>
<div class="form-group"><label>ìŒì‹ ì¢…ë¥˜</label><select id="selFood"><option value="">ì„ íƒ</option></select></div>
<div class="form-group"><label>ì¸ì›</label><select id="selPeople"><option value="">ì„ íƒ</option><option>2~4</option><option>5~10</option><option>10~20</option><option>20+</option></select></div>
<button class="btn btn-primary" onclick="App.din.search()" style="margin-bottom:16px">ğŸ” ê²€ìƒ‰</button>
</div>
</div>
<div id="dinResult"></div>
</div>

<!-- DINING LOG -->
<div class="page" id="pgDiningLog">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
<h2>íšŒì‹ ê¸°ë¡</h2>
<button class="btn btn-primary" onclick="App.dl.openNew()">+ ìƒˆ ê¸°ë¡</button>
</div>
<div class="stats-grid" id="dlStats"></div>
<div class="card"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>ì¥ì†Œ</th><th>ì¸ì›</th><th>ë¹„ìš©</th><th>ê´€ë¦¬</th></tr></thead><tbody id="dlList"></tbody></table></div>
</div>

<!-- CALENDAR -->
<div class="page" id="pgCalendar">
<h2 style="margin-bottom:20px">ìº˜ë¦°ë”</h2>
<div id="calAuthArea" class="cal-auth-box" style="display:none">
<p>Google ìº˜ë¦°ë”ì— ì—°ë™í•˜ì—¬ ì¼ì •ì„ ì¡°íšŒÂ·ë“±ë¡Â·ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
<button class="btn btn-primary" onclick="App.cal.authorize()">ğŸ“… Google ìº˜ë¦°ë” ì—°ë™</button>
</div>
<div id="calMain" style="display:none">
<div class="card">
<div class="cal-header">
<div class="cal-nav">
<button onclick="App.cal.prev()">â—€</button>
<div class="cal-month" id="calMonth"></div>
<button onclick="App.cal.next()">â–¶</button>
</div>
<div style="display:flex;gap:8px">
<button class="btn btn-primary btn-sm" onclick="App.cal.today()">ì˜¤ëŠ˜</button>
<button class="btn btn-success btn-sm" onclick="App.cal.openNew()">+ ì¼ì • ì¶”ê°€</button>
</div>
</div>
<div class="cal-grid" id="calGrid"></div>
</div>
<div class="card" style="margin-top:16px">
<div class="card-title">ì˜ˆì •ëœ ì¼ì •</div>
<div id="calUpcoming"></div>
</div>
</div>
</div>

</main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modalNotice"><div class="modal"><div class="modal-header"><h3 id="mnTitle">ìƒˆ ê³µì§€</h3><button class="modal-close" onclick="App.ui.closeModal('modalNotice')">âœ•</button></div>
<div class="form-group"><label>ì œëª©</label><input id="mnTitleIn" placeholder="ê³µì§€ ì œëª©"></div>
<div class="form-group"><label>ë‚´ìš©</label><textarea id="mnContent" rows="5" placeholder="ê³µì§€ ë‚´ìš©"></textarea></div>
<div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="App.notices.save()">ì €ì¥</button></div>
</div></div>

<div class="modal-overlay" id="modalDL"><div class="modal"><div class="modal-header"><h3 id="dlTitle">íšŒì‹ ê¸°ë¡</h3><button class="modal-close" onclick="App.ui.closeModal('modalDL')">âœ•</button></div>
<div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="dlDate"></div>
<div class="form-group"><label>ì¥ì†Œ</label><input id="dlPlace" placeholder="ì¥ì†Œëª…"></div>
<div class="form-group"><label>ì¸ì›</label><input type="number" id="dlPeople" placeholder="ì¸ì› ìˆ˜"></div>
<div class="form-group"><label>ë¹„ìš©</label><input type="number" id="dlCost" placeholder="ì´ ë¹„ìš©(ì›)"></div>
<div class="form-group"><label>ë©”ëª¨</label><textarea id="dlMemo" rows="3" placeholder="ë©”ëª¨"></textarea></div>
<div style="text-align:right;margin-top:16px"><button class="btn btn-primary" onclick="App.dl.save()">ì €ì¥</button></div>
</div></div>

<div class="modal-overlay" id="modalCal"><div class="modal"><div class="modal-header"><h3 id="calModalTitle">ìƒˆ ì¼ì •</h3><button class="modal-close" onclick="App.ui.closeModal('modalCal')">âœ•</button></div>
<div class="form-group"><label>ì œëª©</label><input id="calEvTitle" placeholder="ì¼ì • ì œëª©"></div>
<div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="calEvDate"></div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label>ì‹œì‘ ì‹œê°„</label><input type="time" id="calEvStart"></div>
<div class="form-group"><label>ì¢…ë£Œ ì‹œê°„</label><input type="time" id="calEvEnd"></div>
</div>
<div class="form-group"><label>ì„¤ëª…</label><textarea id="calEvDesc" rows="3" placeholder="ì¼ì • ì„¤ëª…"></textarea></div>
<div class="form-group"><label>ì•Œë¦¼</label><select id="calEvReminder"><option value="10">10ë¶„ ì „</option><option value="30">30ë¶„ ì „</option><option value="60" selected>1ì‹œê°„ ì „</option><option value="1440">1ì¼ ì „</option></select></div>
<div style="display:flex;justify-content:space-between;margin-top:16px">
<button class="btn btn-danger" id="calEvDel" style="display:none" onclick="App.cal.deleteEvent()">ì‚­ì œ</button>
<div style="margin-left:auto"><button class="btn btn-primary" onclick="App.cal.saveEvent()">ì €ì¥</button></div>
</div>
</div></div>

<!-- CHATBOT -->
<button class="cb-btn" onclick="App.chat.toggle()">ğŸ’¬</button>
<div class="cb-panel" id="cbPanel">
<div class="cb-head"><span>AI ì–´ì‹œìŠ¤í„´íŠ¸</span><button onclick="App.chat.toggle()" style="background:none;border:none;color:#fff;cursor:pointer;font-size:18px">âœ•</button></div>
<div class="cb-msgs" id="cbMsgs"><div class="cb-msg bot">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br>ì˜ˆ: "ë‚´ì¼ 3ì‹œ íšŒì˜ ë“±ë¡", "ê³µì§€ ë“±ë¡", "íšŒì‹ ì°¾ê¸°"</div></div>
<div class="cb-input"><input id="cbIn" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter')App.chat.send()"><button onclick="App.chat.send()">ì „ì†¡</button></div>
</div>
<script>
const $=id=>document.getElementById(id);
const FC={apiKey:'AIzaSyDcHSt46CHlu_LZYnNUU7xwIlMY7xE8KdU',authDomain:'workhub2.firebaseapp.com',projectId:'workhub2'};
firebase.initializeApp(FC);
const fa=firebase.auth(),db=firebase.firestore();

/* â”€â”€ Google Calendar Config â”€â”€ */
const GCAL_CLIENT_ID='535238333900-f0746m5heeijpb55ulhfbm2l15c57r7k.apps.googleusercontent.com';
const GCAL_API_KEY='AIzaSyDcHSt46CHlu_LZYnNUU7xwIlMY7xE8KdU';
const GCAL_DISC='https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
const GCAL_SCOPE='https://www.googleapis.com/auth/calendar';
let gTokenClient=null,gapiInited=false,gisInited=false,calAuthorized=false;

/* â”€â”€ State â”€â”€ */
const S={user:null,editNotice:null,editDL:null,editCalEv:null,calYear:new Date().getFullYear(),calMonth:new Date().getMonth(),calEvents:[]};

/* â”€â”€ Helpers â”€â”€ */
function toast(m,t=''){const d=document.createElement('div');d.className='toast '+(t||'');d.textContent=m;$('toastWrap').appendChild(d);setTimeout(()=>d.remove(),3000)}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function tAgo(ts){if(!ts)return'';const s=Math.floor((Date.now()-ts.toDate().getTime())/1000);if(s<60)return'ë°©ê¸ˆ';if(s<3600)return Math.floor(s/60)+'ë¶„ ì „';if(s<86400)return Math.floor(s/3600)+'ì‹œê°„ ì „';return Math.floor(s/86400)+'ì¼ ì „'}
function fmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function fmtMoney(n){return Number(n).toLocaleString()+'ì›'}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const App={

/* â”€â”€ Auth â”€â”€ */
auth:{
  login(){
    fa.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>toast('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message,'error'))
  },
  logout(){
    if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))fa.signOut()
  },
  update(u){
    S.user=u;
    if(u){
      $('pgLogin').style.display='none';
      $('appShell').style.display='';
      const nm=u.displayName||u.email;
      $('hAvatar').textContent=nm.charAt(0).toUpperCase();
      $('hAvatar').title=nm+' (í´ë¦­: ë¡œê·¸ì•„ì›ƒ)';
      App.dash.load();
      App.cal.initGapi();
    }else{
      $('pgLogin').style.display='';
      $('appShell').style.display='none';
      calAuthorized=false;
    }
  }
},

/* â”€â”€ UI â”€â”€ */
ui:{
  toggleSidebar(){
    const sb=$('sidebar');
    if(window.innerWidth<=768){sb.classList.toggle('mobile-open')}
    else{sb.classList.toggle('collapsed');$('mainContent').classList.toggle('expanded')}
  },
  search(e){
    if(e.key==='Enter'){const q=$('globalSearch').value.trim().toLowerCase();if(q)toast('ê²€ìƒ‰: '+q)}
  },
  closeModal(id){$(id).classList.remove('show')},
  openModal(id){$(id).classList.add('show')}
},

/* â”€â”€ Router â”€â”€ */
rt:{
  go(pg){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.sb-item').forEach(s=>s.classList.remove('active'));
    $(pg).classList.add('active');
    const si=document.querySelector(`.sb-item[data-pg="${pg}"]`);
    if(si)si.classList.add('active');
    if(pg==='pgDash')App.dash.load();
    if(pg==='pgNotices')App.notices.load();
    if(pg==='pgDining')App.din.init();
    if(pg==='pgDiningLog')App.dl.load();
    if(pg==='pgCalendar')App.cal.show();
    if(window.innerWidth<=768)$('sidebar').classList.remove('mobile-open');
  }
},

/* â”€â”€ Dashboard â”€â”€ */
dash:{
  async load(){
    try{
      const ns=await db.collection('notices').orderBy('created','desc').limit(5).get();
      const ds=await db.collection('dining').orderBy('date','desc').limit(5).get();
      const nc=ns.size,dc=ds.size;
      let totalCost=0;ds.forEach(d=>{totalCost+=(d.data().cost||0)});
      $('dashStats').innerHTML=`
        <div class="stat-card"><div class="stat-num">${nc}</div><div class="stat-label">ê³µì§€ì‚¬í•­</div></div>
        <div class="stat-card"><div class="stat-num">${dc}</div><div class="stat-label">íšŒì‹ ê¸°ë¡</div></div>
        <div class="stat-card"><div class="stat-num">${fmtMoney(totalCost)}</div><div class="stat-label">ì´ íšŒì‹ ë¹„ìš©</div></div>
        <div class="stat-card"><div class="stat-num">${calAuthorized?S.calEvents.length:'â€”'}</div><div class="stat-label">ì˜ˆì • ì¼ì •</div></div>`;
      let nh='';ns.forEach(d=>{const v=d.data();nh+=`<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><span>${esc(v.title)}</span><span style="color:var(--textSec);font-size:12px">${tAgo(v.created)}</span></div>`});
      $('dashNotices').innerHTML=nh||'<p style="color:var(--textSec);font-size:13px">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
      let dh='';ds.forEach(d=>{const v=d.data();dh+=`<div style="padding:8px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between"><span>${esc(v.place||'')} (${v.people||0}ëª…)</span><span style="color:var(--textSec);font-size:12px">${v.date||''}</span></div>`});
      $('dashDining').innerHTML=dh||'<p style="color:var(--textSec);font-size:13px">íšŒì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    }catch(e){console.error(e)}
  }
},

/* â”€â”€ Notices â”€â”€ */
notices:{
  async load(){
    const snap=await db.collection('notices').orderBy('created','desc').get();
    let h='';snap.forEach(d=>{const v=d.data();h+=`<tr>
      <td><strong>${esc(v.title)}</strong></td>
      <td>${esc(v.author||'')}</td>
      <td>${tAgo(v.created)}</td>
      <td>
        <button class="btn btn-secondary btn-sm" onclick="App.notices.edit('${d.id}')">ìˆ˜ì •</button>
        <button class="btn btn-danger btn-sm" onclick="App.notices.del('${d.id}')">ì‚­ì œ</button>
      </td></tr>`});
    $('noticeList').innerHTML=h||'<tr><td colspan="4" style="text-align:center;color:var(--textSec)">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  },
  openNew(){S.editNotice=null;$('mnTitle').textContent='ìƒˆ ê³µì§€';$('mnTitleIn').value='';$('mnContent').value='';App.ui.openModal('modalNotice')},
  async edit(id){
    const d=await db.collection('notices').doc(id).get();
    if(!d.exists)return;
    S.editNotice=id;const v=d.data();
    $('mnTitle').textContent='ê³µì§€ ìˆ˜ì •';$('mnTitleIn').value=v.title||'';$('mnContent').value=v.content||'';
    App.ui.openModal('modalNotice');
  },
  async save(){
    const t=$('mnTitleIn').value.trim(),c=$('mnContent').value.trim();
    if(!t){toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return}
    const data={title:t,content:c,author:S.user.displayName||S.user.email,created:firebase.firestore.FieldValue.serverTimestamp()};
    if(S.editNotice)await db.collection('notices').doc(S.editNotice).update(data);
    else await db.collection('notices').add(data);
    App.ui.closeModal('modalNotice');toast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');App.notices.load();
  },
  async del(id){if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){await db.collection('notices').doc(id).delete();toast('ì‚­ì œë¨','success');App.notices.load()}}
},

/* â”€â”€ Dining Finder â”€â”€ */
din:{
  foods:['í•œì‹','ì¤‘ì‹','ì¼ì‹','ì–‘ì‹','ì¹˜í‚¨','í”¼ì','ê³ ê¸°/ì‚¼ê²¹ì‚´','í•´ì‚°ë¬¼','ë¶„ì‹','ë² íŠ¸ë‚¨/íƒœêµ­','ì¸ë„','ë©•ì‹œì¹¸','ë·”í˜','ìˆ ì§‘/í˜¸í”„','ì¹´í˜'],
  regions:['ì„œìš¸ ê°•ë‚¨','ì„œìš¸ í™ëŒ€','ì„œìš¸ ì¢…ë¡œ','ì„œìš¸ ì—¬ì˜ë„','ì„œìš¸ ì‹ ì´Œ','ì„œìš¸ ì´íƒœì›','ì„œìš¸ ê±´ëŒ€','ì„œìš¸ ì†¡íŒŒ','ì„œìš¸ ë§ˆí¬','ê²½ê¸° ìˆ˜ì›','ê²½ê¸° ì„±ë‚¨','ë¶€ì‚° ì„œë©´','ë¶€ì‚° í•´ìš´ëŒ€','ëŒ€ì „ ë‘”ì‚°','ëŒ€êµ¬ ë™ì„±ë¡œ','ì¸ì²œ ë¶€í‰','ê´‘ì£¼ ì¶©ì¥ë¡œ'],
  init(){
    const r=$('selRegion'),f=$('selFood');
    if(r.options.length<=1){this.regions.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;r.appendChild(o)})}
    if(f.options.length<=1){this.foods.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;f.appendChild(o)})}
  },
  search(){
    const r=$('selRegion').value,f=$('selFood').value;
    if(!r){toast('ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”','error');return}
    if(!f){toast('ìŒì‹ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return}
    const p=$('selPeople').value,q=r+' '+f+(p?' '+p+'ì¸':'');
    window.open('https://map.naver.com/v5/search/'+encodeURIComponent(q),'_blank');
    toast('"'+q+'" ê²€ìƒ‰ ê²°ê³¼');
  }
},

/* â”€â”€ Dining Log â”€â”€ */
dl:{
  async load(){
    const snap=await db.collection('dining').orderBy('date','desc').get();
    let h='',total=0,cnt=0;
    snap.forEach(d=>{const v=d.data();cnt++;total+=(v.cost||0);
      h+=`<tr>
        <td>${esc(v.date||'')}</td><td>${esc(v.place||'')}</td><td>${v.people||0}ëª…</td><td>${fmtMoney(v.cost||0)}</td>
        <td>
          <button class="btn btn-secondary btn-sm" onclick="App.dl.edit('${d.id}')">ìˆ˜ì •</button>
          <button class="btn btn-danger btn-sm" onclick="App.dl.del('${d.id}')">ì‚­ì œ</button>
        </td></tr>`});
    $('dlList').innerHTML=h||'<tr><td colspan="5" style="text-align:center;color:var(--textSec)">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
    $('dlStats').innerHTML=`
      <div class="stat-card"><div class="stat-num">${cnt}</div><div class="stat-label">ì´ íšŒì‹ íšŸìˆ˜</div></div>
      <div class="stat-card"><div class="stat-num">${fmtMoney(total)}</div><div class="stat-label">ì´ ë¹„ìš©</div></div>
      <div class="stat-card"><div class="stat-num">${cnt?fmtMoney(Math.round(total/cnt)):'-'}</div><div class="stat-label">íšŒë‹¹ í‰ê· </div></div>`;
  },
  openNew(){S.editDL=null;$('dlTitle').textContent='ìƒˆ íšŒì‹ ê¸°ë¡';$('dlDate').value=fmtDate(new Date());$('dlPlace').value='';$('dlPeople').value='';$('dlCost').value='';$('dlMemo').value='';App.ui.openModal('modalDL')},
  async edit(id){
    const d=await db.collection('dining').doc(id).get();if(!d.exists)return;S.editDL=id;const v=d.data();
    $('dlTitle').textContent='ê¸°ë¡ ìˆ˜ì •';$('dlDate').value=v.date||'';$('dlPlace').value=v.place||'';$('dlPeople').value=v.people||'';$('dlCost').value=v.cost||'';$('dlMemo').value=v.memo||'';
    App.ui.openModal('modalDL');
  },
  async save(){
    const data={date:$('dlDate').value,place:$('dlPlace').value.trim(),people:Number($('dlPeople').value)||0,cost:Number($('dlCost').value)||0,memo:$('dlMemo').value.trim(),created:firebase.firestore.FieldValue.serverTimestamp()};
    if(!data.place){toast('ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return}
    if(S.editDL)await db.collection('dining').doc(S.editDL).update(data);
    else await db.collection('dining').add(data);
    App.ui.closeModal('modalDL');toast('ì €ì¥ë¨','success');App.dl.load();
  },
  async del(id){if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){await db.collection('dining').doc(id).delete();toast('ì‚­ì œë¨','success');App.dl.load()}}
},

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR (Google Calendar API)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
cal:{
  /* â”€â”€ GAPI / GIS Init â”€â”€ */
  initGapi(){
    gapi.load('client',async()=>{
      await gapi.client.init({apiKey:GCAL_API_KEY,discoveryDocs:[GCAL_DISC]});
      gapiInited=true;
      this.maybeAutoShow();
    });
    gTokenClient=google.accounts.oauth2.initTokenClient({
      client_id:GCAL_CLIENT_ID,
      scope:GCAL_SCOPE,
      callback:''
    });
    gisInited=true;
  },

  maybeAutoShow(){
    if(gapiInited&&gapi.client.getToken()){
      calAuthorized=true;
      this.show();
    }
  },

  /* â”€â”€ Authorize â”€â”€ */
  authorize(){
    if(!gapiInited||!gisInited){toast('Google API ë¡œë”© ì¤‘... ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”','error');return}
    gTokenClient.callback=async(resp)=>{
      if(resp.error)return toast('ì¸ì¦ ì‹¤íŒ¨: '+resp.error,'error');
      calAuthorized=true;
      toast('Google ìº˜ë¦°ë” ì—°ë™ ì™„ë£Œ!','success');
      App.cal.show();
    };
    if(!gapi.client.getToken()){
      gTokenClient.requestAccessToken({prompt:'consent'});
    }else{
      gTokenClient.requestAccessToken({prompt:''});
    }
  },

  /* â”€â”€ Show Calendar Page â”€â”€ */
  show(){
    if(!calAuthorized){
      $('calAuthArea').style.display='';
      $('calMain').style.display='none';
      return;
    }
    $('calAuthArea').style.display='none';
    $('calMain').style.display='';
    this.render();
    this.fetchEvents();
  },

  /* â”€â”€ Navigation â”€â”€ */
  prev(){S.calMonth--;if(S.calMonth<0){S.calMonth=11;S.calYear--}this.render();this.fetchEvents()},
  next(){S.calMonth++;if(S.calMonth>11){S.calMonth=0;S.calYear++}this.render();this.fetchEvents()},
  today(){const n=new Date();S.calYear=n.getFullYear();S.calMonth=n.getMonth();this.render();this.fetchEvents()},

  /* â”€â”€ Render Grid â”€â”€ */
  render(){
    const y=S.calYear,m=S.calMonth;
    const months=['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
    $('calMonth').textContent=y+'ë…„ '+months[m];
    const first=new Date(y,m,1),last=new Date(y,m+1,0);
    const startDay=first.getDay(),totalDays=last.getDate();
    const today=new Date(),todayStr=fmtDate(today);
    let html='';
    const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    dayNames.forEach((d,i)=>{html+=`<div class="cal-day-header" style="color:${i===0?'var(--danger)':i===6?'var(--primary)':'var(--textSec)'}">${d}</div>`});

    // prev month fill
    const prevLast=new Date(y,m,0).getDate();
    for(let i=startDay-1;i>=0;i--){
      const d=prevLast-i;
      html+=`<div class="cal-day other-month"><div class="day-num">${d}</div></div>`;
    }
    // current month
    for(let d=1;d<=totalDays;d++){
      const ds=y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
      const isToday=ds===todayStr;
      const dow=new Date(y,m,d).getDay();
      const dayClass=dow===0?'sun':dow===6?'sat':'';
      const evts=S.calEvents.filter(e=>(e.start.dateTime||e.start.date||'').substring(0,10)===ds);
      let evHtml='';
      const colors=['ev-blue','ev-green','ev-red','ev-yellow'];
      evts.slice(0,2).forEach((ev,i)=>{evHtml+=`<div class="cal-event ${colors[i%4]}" onclick="event.stopPropagation();App.cal.editEvent('${ev.id}')" title="${esc(ev.summary||'')}">${esc(ev.summary||'(ì œëª© ì—†ìŒ)')}</div>`});
      if(evts.length>2)evHtml+=`<div class="cal-event-more">+${evts.length-2}ê°œ ë”</div>`;
      html+=`<div class="cal-day${isToday?' today':''}" onclick="App.cal.openNewOnDate('${ds}')">
        <div class="day-num ${dayClass}">${d}</div>${evHtml}</div>`;
    }
    // next month fill
    const remain=(startDay+totalDays)%7;
    if(remain>0){for(let i=1;i<=7-remain;i++){html+=`<div class="cal-day other-month"><div class="day-num">${i}</div></div>`}}
    $('calGrid').innerHTML=html;
  },

  /* â”€â”€ Fetch Events â”€â”€ */
  async fetchEvents(){
    if(!calAuthorized)return;
    try{
      const tMin=new Date(S.calYear,S.calMonth,1).toISOString();
      const tMax=new Date(S.calYear,S.calMonth+1,0,23,59,59).toISOString();
      const resp=await gapi.client.calendar.events.list({
        calendarId:'primary',
        timeMin:tMin,
        timeMax:tMax,
        showDeleted:false,
        singleEvents:true,
        maxResults:100,
        orderBy:'startTime'
      });
      S.calEvents=resp.result.items||[];
      this.render();
      this.renderUpcoming();
    }catch(e){
      console.error('ìº˜ë¦°ë” ì´ë²¤íŠ¸ ì¡°íšŒ ì‹¤íŒ¨',e);
      if(e.status===401){calAuthorized=false;this.show()}
    }
  },

  /* â”€â”€ Upcoming List â”€â”€ */
  renderUpcoming(){
    const now=new Date();
    const upcoming=S.calEvents.filter(e=>{
      const st=new Date(e.start.dateTime||e.start.date);
      return st>=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    }).slice(0,10);
    if(!upcoming.length){$('calUpcoming').innerHTML='<p style="color:var(--textSec);font-size:13px">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';return}
    let h='';
    upcoming.forEach(ev=>{
      const st=ev.start.dateTime?new Date(ev.start.dateTime):null;
      const timeStr=st?st.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'ì¢…ì¼';
      const dateStr=(ev.start.dateTime||ev.start.date||'').substring(0,10);
      h+=`<div style="padding:10px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;cursor:pointer" onclick="App.cal.editEvent('${ev.id}')">
        <div>
          <div style="font-weight:600;font-size:14px">${esc(ev.summary||'(ì œëª© ì—†ìŒ)')}</div>
          <div style="font-size:12px;color:var(--textSec)">${dateStr} ${timeStr}</div>
        </div>
        <span class="badge badge-blue">${timeStr}</span>
      </div>`;
    });
    $('calUpcoming').innerHTML=h;
  },

  /* â”€â”€ New Event â”€â”€ */
  openNew(){
    S.editCalEv=null;
    $('calModalTitle').textContent='ìƒˆ ì¼ì •';
    $('calEvTitle').value='';$('calEvDate').value=fmtDate(new Date());
    $('calEvStart').value='09:00';$('calEvEnd').value='10:00';
    $('calEvDesc').value='';$('calEvReminder').value='60';
    $('calEvDel').style.display='none';
    App.ui.openModal('modalCal');
  },
  openNewOnDate(ds){
    S.editCalEv=null;
    $('calModalTitle').textContent='ìƒˆ ì¼ì •';
    $('calEvTitle').value='';$('calEvDate').value=ds;
    $('calEvStart').value='09:00';$('calEvEnd').value='10:00';
    $('calEvDesc').value='';$('calEvReminder').value='60';
    $('calEvDel').style.display='none';
    App.ui.openModal('modalCal');
  },

  /* â”€â”€ Edit Event â”€â”€ */
  async editEvent(evId){
    try{
      const resp=await gapi.client.calendar.events.get({calendarId:'primary',eventId:evId});
      const ev=resp.result;
      S.editCalEv=evId;
      $('calModalTitle').textContent='ì¼ì • ìˆ˜ì •';
      $('calEvTitle').value=ev.summary||'';
      const sd=ev.start.dateTime||ev.start.date||'';
      $('calEvDate').value=sd.substring(0,10);
      if(ev.start.dateTime){
        $('calEvStart').value=sd.substring(11,16);
        $('calEvEnd').value=(ev.end.dateTime||'').substring(11,16);
      }else{
        $('calEvStart').value='09:00';$('calEvEnd').value='10:00';
      }
      $('calEvDesc').value=ev.description||'';
      if(ev.reminders&&ev.reminders.overrides&&ev.reminders.overrides.length){
        $('calEvReminder').value=ev.reminders.overrides[0].minutes;
      }else{$('calEvReminder').value='60'}
      $('calEvDel').style.display='';
      App.ui.openModal('modalCal');
    }catch(e){toast('ì¼ì • ì¡°íšŒ ì‹¤íŒ¨','error');console.error(e)}
  },

  /* â”€â”€ Save Event â”€â”€ */
  async saveEvent(){
    const title=$('calEvTitle').value.trim();
    if(!title){toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return}
    const date=$('calEvDate').value;
    const st=$('calEvStart').value;
    const et=$('calEvEnd').value;
    const desc=$('calEvDesc').value.trim();
    const reminder=Number($('calEvReminder').value);

    const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||'Asia/Seoul';
    const event={
      summary:title,
      description:desc,
      start:{dateTime:date+'T'+st+':00',timeZone:tz},
      end:{dateTime:date+'T'+et+':00',timeZone:tz},
      reminders:{useDefault:false,overrides:[
        {method:'popup',minutes:reminder},
        {method:'email',minutes:reminder}
      ]}
    };

    try{
      if(S.editCalEv){
        await gapi.client.calendar.events.update({calendarId:'primary',eventId:S.editCalEv,resource:event});
        toast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success');
      }else{
        await gapi.client.calendar.events.insert({calendarId:'primary',resource:event});
        toast('ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');
      }
      App.ui.closeModal('modalCal');
      this.fetchEvents();
    }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.result?.error?.message||e.message,'error');console.error(e)}
  },

  /* â”€â”€ Delete Event â”€â”€ */
  async deleteEvent(){
    if(!S.editCalEv)return;
    if(!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
    try{
      await gapi.client.calendar.events.delete({calendarId:'primary',eventId:S.editCalEv});
      toast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');
      App.ui.closeModal('modalCal');
      this.fetchEvents();
    }catch(e){toast('ì‚­ì œ ì‹¤íŒ¨','error');console.error(e)}
  }
},

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHATBOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
chat:{
  toggle(){$('cbPanel').classList.toggle('open')},
  addMsg(text,cls){
    const d=document.createElement('div');d.className='cb-msg '+cls;d.innerHTML=text;
    $('cbMsgs').appendChild(d);$('cbMsgs').scrollTop=$('cbMsgs').scrollHeight;
  },
  async send(){
    const v=$('cbIn').value.trim();if(!v)return;
    $('cbIn').value='';this.addMsg(esc(v),'user');
    const lower=v.toLowerCase();

    // ìº˜ë¦°ë” ì¼ì • ë“±ë¡
    if(calAuthorized&&(lower.includes('ì¼ì •')&&(lower.includes('ë“±ë¡')||lower.includes('ì¶”ê°€')||lower.includes('ë§Œë“¤')))){
      const parsed=this.parseCalEvent(v);
      if(parsed){
        try{
          const tz=Intl.DateTimeFormat().resolvedOptions().timeZone||'Asia/Seoul';
          const event={
            summary:parsed.title,
            start:{dateTime:parsed.date+'T'+parsed.start+':00',timeZone:tz},
            end:{dateTime:parsed.date+'T'+parsed.end+':00',timeZone:tz},
            reminders:{useDefault:false,overrides:[{method:'popup',minutes:60}]}
          };
          await gapi.client.calendar.events.insert({calendarId:'primary',resource:event});
          this.addMsg(`ğŸ“… ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!<br><b>${esc(parsed.title)}</b><br>${parsed.date} ${parsed.start}~${parsed.end}`,'bot');
          App.cal.fetchEvents();
          return;
        }catch(e){this.addMsg('ì¼ì • ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: '+e.message,'bot');return}
      }
    }

    // ì˜¤ëŠ˜/ë‚´ì¼ ì¼ì • ì¡°íšŒ
    if(calAuthorized&&lower.includes('ì¼ì •')&&(lower.includes('ì¡°íšŒ')||lower.includes('í™•ì¸')||lower.includes('ë³´ì—¬')||lower.includes('ì•Œë ¤'))){
      try{
        const target=lower.includes('ë‚´ì¼')?new Date(Date.now()+86400000):new Date();
        const ds=fmtDate(target);
        const tMin=ds+'T00:00:00+09:00';const tMax=ds+'T23:59:59+09:00';
        const resp=await gapi.client.calendar.events.list({calendarId:'primary',timeMin:new Date(tMin).toISOString(),timeMax:new Date(tMax).toISOString(),singleEvents:true,orderBy:'startTime'});
        const items=resp.result.items||[];
        if(!items.length){this.addMsg(`ğŸ“… ${ds}ì— ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.`,'bot');return}
        let msg=`ğŸ“… <b>${ds} ì¼ì • (${items.length}ê±´)</b><br>`;
        items.forEach(ev=>{
          const t=ev.start.dateTime?new Date(ev.start.dateTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'ì¢…ì¼';
          msg+=`â€¢ ${t} ${esc(ev.summary||'(ì œëª©ì—†ìŒ)')}<br>`;
        });
        this.addMsg(msg,'bot');return;
      }catch(e){this.addMsg('ì¼ì • ì¡°íšŒ ì‹¤íŒ¨: '+e.message,'bot');return}
    }

    // ê³µì§€ ë“±ë¡
    if(lower.includes('ê³µì§€')&&(lower.includes('ë“±ë¡')||lower.includes('ì¶”ê°€')||lower.includes('ì‘ì„±'))){
      const m=v.match(/ê³µì§€.*?(?:ë“±ë¡|ì¶”ê°€|ì‘ì„±)[:\s]*(.+)/i);
      if(m&&m[1]){
        await db.collection('notices').add({title:m[1].trim(),content:'',author:S.user.displayName||'',created:firebase.firestore.FieldValue.serverTimestamp()});
        this.addMsg('ğŸ“‹ ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤: <b>'+esc(m[1].trim())+'</b>','bot');
        return;
      }
      this.addMsg('ì‚¬ìš©ë²•: "ê³µì§€ ë“±ë¡: ì œëª©"','bot');return;
    }

    // íšŒì‹ ì°¾ê¸°
    if(lower.includes('íšŒì‹')&&lower.includes('ì°¾')){
      this.addMsg('ğŸ½ï¸ íšŒì‹ ì°¾ê¸° í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.','bot');
      App.rt.go('pgDining');return;
    }

    // ê¸°ë³¸ ì‘ë‹µ
    const replies=['ë„¤, ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?','ë§ì”€í•´ì£¼ì„¸ìš”!','ë” êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì‹œë©´ ë„ì›€ì´ ë  ìˆ˜ ìˆì–´ìš”.'];
    this.addMsg(replies[Math.floor(Math.random()*replies.length)],'bot');
  },

  /* â”€â”€ Parse natural language for calendar event â”€â”€ */
  parseCalEvent(text){
    let title='íšŒì˜',date='',start='09:00',end='10:00';
    const today=new Date();

    // date
    if(/ë‚´ì¼/.test(text)){date=fmtDate(new Date(today.getTime()+86400000))}
    else if(/ëª¨ë ˆ|ë‚´ì¼\s*ëª¨ë ˆ/.test(text)){date=fmtDate(new Date(today.getTime()+2*86400000))}
    else if(/ì˜¤ëŠ˜/.test(text)){date=fmtDate(today)}
    else{
      const dm=text.match(/(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
      if(dm)date=today.getFullYear()+'-'+dm[1].padStart(2,'0')+'-'+dm[2].padStart(2,'0');
      else date=fmtDate(today);
    }

    // time
    const tm=text.match(/(\d{1,2})\s*ì‹œ/);
    if(tm){
      let h=parseInt(tm[1]);
      if(h<8)h+=12; // assume PM
      start=String(h).padStart(2,'0')+':00';
      const mm=text.match(/(\d{1,2})\s*ì‹œ\s*(\d{1,2})\s*ë¶„/);
      if(mm)start=String(h).padStart(2,'0')+':'+mm[2].padStart(2,'0');
      end=String(h+1).padStart(2,'0')+':00';
    }

    // title - extract meaningful part
    const tp=text.replace(/.*ì¼ì •\s*(ë“±ë¡|ì¶”ê°€|ë§Œë“¤[ì–´ê¸°]?)\s*/i,'').replace(/ë‚´ì¼|ì˜¤ëŠ˜|ëª¨ë ˆ/g,'').replace(/(\d{1,2})ì›”\s*(\d{1,2})ì¼/g,'').replace(/(\d{1,2})\s*ì‹œ\s*(\d{1,2})?\s*ë¶„?/g,'').trim();
    if(tp)title=tp;

    return{title,date,start,end};
  }
}

};/* end App */

/* â”€â”€ Auth State â”€â”€ */
fa.onAuthStateChanged(u=>App.auth.update(u));

/* â”€â”€ Close modals on overlay click â”€â”€ */
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show')});
});
</script>
</body>
</html>
