<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=5">
<meta name="description" content="WorkHub - Enterprise Smart Groupware">
<meta name="theme-color" content="#6366f1">
<title>WorkHub - Enterprise Groupware</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
<style>
/* ===== Design Tokens ===== */
:root{--bg:#f5f6fa;--bg-card:#fff;--bg-side:#1a1d2e;--bg-input:#f8f9fb;--bd:#e5e7eb;--bd-focus:#6366f1;--t1:#111827;--t2:#6b7280;--t3:#9ca3af;--tw:#fff;--ac:#6366f1;--ac-l:#eef2ff;--ac-d:#4f46e5;--ok:#10b981;--ok-l:#d1fae5;--wn:#f59e0b;--wn-l:#fef3c7;--err:#ef4444;--err-l:#fee2e2;--or:#f97316;--pu:#8b5cf6;--sh:0 1px 3px rgba(0,0,0,.1);--sh-md:0 4px 6px -1px rgba(0,0,0,.1);--sh-lg:0 10px 15px -3px rgba(0,0,0,.1);--sh-xl:0 20px 25px -5px rgba(0,0,0,.1);--r:8px;--rl:12px;--rxl:16px;--ff:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;--hh:60px;--sw:250px;--tr:all .2s cubic-bezier(.4,0,.2,1)}

/* ===== Reset & Base ===== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;scroll-behavior:smooth}
body{font-family:var(--ff);font-size:.875rem;color:var(--t1);background:var(--bg);line-height:1.6;min-height:100vh;overflow-x:hidden}
button{font-family:var(--ff);cursor:pointer;border:none;background:none}
input,textarea,select{font-family:var(--ff);border:none;outline:none}
[hidden]{display:none!important}
:focus-visible{outline:2px solid var(--ac);outline-offset:2px;border-radius:var(--r)}
::selection{background:var(--ac-l);color:var(--ac-d)}
img{max-width:100%;height:auto}

/* ===== Animations ===== */
@keyframes sU{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
@keyframes sD{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:none}}
@keyframes fI{from{opacity:0}to{opacity:1}}
@keyframes tI{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:none}}
@keyframes tO{from{opacity:1}to{opacity:0;transform:translateX(40px)}}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes bI{0%{opacity:0;transform:scale(.3)}50%{transform:scale(1.05)}100%{opacity:1;transform:scale(1)}}
@keyframes fp{0%,100%{box-shadow:0 4px 20px rgba(99,102,241,.4)}50%{box-shadow:0 4px 20px rgba(99,102,241,.65),0 0 0 10px rgba(99,102,241,.06)}}
@keyframes dB{0%,80%,100%{opacity:0}40%{opacity:1}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes barSlide{from{height:0;opacity:0}to{height:20px;opacity:1}}
@keyframes menuIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes iconPop{0%{transform:scale(1)}50%{transform:scale(1.25) rotate(-8deg)}100%{transform:scale(1)}}
@keyframes menuFlash{0%{background:rgba(99,102,241,.5);transform:translateX(10px)}50%{background:rgba(99,102,241,.35)}100%{background:rgba(99,102,241,.25);transform:translateX(4px)}}

/* ===== Skeleton Loading ===== */
.skel{background:linear-gradient(90deg,var(--bg-input) 25%,#e8e8e8 50%,var(--bg-input) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--r)}
.skel-text{height:14px;margin-bottom:8px;width:80%}
.skel-title{height:20px;margin-bottom:12px;width:60%}
.skel-card{height:120px;margin-bottom:12px}

/* ===== Toast ===== */
.tw{position:fixed;top:16px;right:16px;z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.to{pointer-events:auto;display:flex;align-items:center;gap:10px;padding:12px 20px;border-radius:var(--r);font-size:.8125rem;font-weight:500;max-width:380px;box-shadow:var(--sh-lg);animation:tI .3s ease-out both;border-left:4px solid transparent;background:#fff}
.to--d{animation:tO .25s ease-in both}
.to--ok{color:#065f46;border-left-color:var(--ok)}
.to--err{color:#991b1b;border-left-color:var(--err)}
.to--info{color:var(--t1);border-left-color:var(--ac)}

/* ===== Login ===== */
.lp{min-height:100vh;display:flex}
.lp-l{flex:1;background:linear-gradient(135deg,#1e1b4b,#312e81,#4f46e5);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:3rem;position:relative;overflow:hidden}
.lp-l::before{content:'';position:absolute;width:500px;height:500px;border-radius:50%;background:rgba(255,255,255,.03);top:-180px;right:-180px}
.lp-l::after{content:'';position:absolute;width:350px;height:350px;border-radius:50%;background:rgba(255,255,255,.02);bottom:-80px;left:-80px}
.lp-brand{position:relative;z-index:1;text-align:center;color:#fff}
.lp-brand h1{font-size:3rem;font-weight:900;letter-spacing:-1.5px;margin-bottom:.5rem}
.lp-brand p{font-size:1rem;opacity:.7;letter-spacing:.5px}
.lp-feats{position:relative;z-index:1;margin-top:3rem;display:flex;flex-direction:column;gap:1.25rem}
.lp-ft{display:flex;align-items:center;gap:12px;color:rgba(255,255,255,.85);font-size:.875rem;font-weight:500}
.lp-ft-i{width:40px;height:40px;border-radius:10px;background:rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.lp-ft-i svg{width:20px;height:20px;stroke:rgba(255,255,255,.9);fill:none;stroke-width:2}
.lp-r{width:480px;display:flex;align-items:center;justify-content:center;padding:3rem;background:#fff}
.lp-form{width:100%;max-width:360px}
.lp-form h2{font-size:1.75rem;font-weight:800;color:var(--t1);margin-bottom:.5rem}
.lp-form>p{color:var(--t2);margin-bottom:2rem;font-size:.9375rem}
.bg{width:100%;padding:14px;background:#fff;border:1px solid var(--bd);border-radius:var(--r);font-size:.9375rem;font-weight:600;color:var(--t1);display:flex;align-items:center;justify-content:center;gap:10px;transition:var(--tr)}
.bg:hover:not(:disabled){background:var(--bg-input);box-shadow:var(--sh-md);transform:translateY(-1px)}
.bg:disabled{opacity:.5;cursor:wait}
.bg svg{width:20px;height:20px;flex-shrink:0}
.sp{display:inline-block;width:20px;height:20px;border:2.5px solid var(--bd);border-top-color:var(--ac);border-radius:50%;animation:sp .6s linear infinite}
.le{margin-top:12px;padding:12px 16px;background:var(--err-l);border:1px solid #fecaca;border-radius:var(--r);font-size:.8125rem;color:#991b1b;display:none;line-height:1.6}
.le--s{display:block}
.le strong{font-weight:700}
.lp-foot{text-align:center;font-size:.75rem;color:var(--t3);margin-top:2rem}

/* ===== Header ===== */
.hd{height:var(--hh);background:#fff;border-bottom:1px solid var(--bd);position:sticky;top:0;z-index:20;box-shadow:0 1px 2px rgba(0,0,0,.05)}
.hd-in{max-width:1600px;margin:0 auto;height:100%;padding:0 24px;display:flex;align-items:center;justify-content:space-between}
.hd-left{display:flex;align-items:center;gap:16px}
.hd-menu{display:none;padding:6px;border-radius:6px;color:var(--t2);transition:var(--tr)}
.hd-menu:hover{background:var(--bg-input)}
.hd-logo{font-size:1.375rem;font-weight:900;color:var(--ac);letter-spacing:-1px;cursor:pointer;user-select:none}
.hd-search{margin-left:24px;position:relative}
.hd-search input{width:260px;padding:8px 12px 8px 36px;background:var(--bg-input);border:1px solid var(--bd);border-radius:var(--r);font-size:.8125rem;color:var(--t1);transition:var(--tr)}
.hd-search input:focus{border-color:var(--ac);background:#fff;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.hd-search input::placeholder{color:var(--t3)}
.hd-search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:16px;height:16px;color:var(--t3);pointer-events:none}
.hd-rt{display:flex;align-items:center;gap:8px}
.hd-noti{position:relative;width:36px;height:36px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;color:var(--t2);transition:var(--tr)}
.hd-noti:hover{background:var(--bg-input)}
.hd-noti svg{width:20px;height:20px}
.hd-noti-b{position:absolute;top:4px;right:4px;width:8px;height:8px;background:var(--err);border-radius:50%;border:2px solid #fff}
.hd-div{width:1px;height:28px;background:var(--bd);margin:0 8px}
.hd-prof{display:flex;align-items:center;gap:10px;padding:6px 12px 6px 6px;border-radius:var(--r);transition:var(--tr);cursor:pointer}
.hd-prof:hover{background:var(--bg-input)}
.hd-av{width:32px;height:32px;border-radius:50%;background:var(--ac-l);display:flex;align-items:center;justify-content:center;overflow:hidden}
.hd-av img{width:100%;height:100%;object-fit:cover}
.hd-av svg{width:16px;height:16px;color:var(--ac)}
.hd-pi{display:flex;flex-direction:column}
.hd-pn{font-size:.8125rem;font-weight:600;color:var(--t1);line-height:1.2}
.hd-pe{font-size:.6875rem;color:var(--t3);line-height:1.2}
.hd-lo{width:36px;height:36px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;color:var(--t3);transition:var(--tr)}
.hd-lo:hover{background:var(--err-l);color:var(--err)}
.hd-lo svg{width:18px;height:18px}

/* ===== Layout ===== */
.al{display:flex;min-height:calc(100vh - var(--hh))}
.sb{width:var(--sw);background:var(--bg-side);flex-shrink:0;display:flex;flex-direction:column;padding:20px 12px;overflow-y:auto;transition:transform .3s cubic-bezier(.4,0,.2,1)}
.sb-lb{font-size:.6875rem;font-weight:700;color:rgba(255,255,255,.35);text-transform:uppercase;letter-spacing:1.5px;padding:12px 14px 8px;margin-top:4px;animation:menuIn .3s ease-out both}
.sb-nav{display:flex;flex-direction:column;gap:2px}
.sb-lk{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:var(--r);font-size:.8125rem;font-weight:500;color:rgba(255,255,255,.6);transition:var(--tr);position:relative}
.sb-lk:hover{transform:translateX(6px);background:rgba(255,255,255,.07);color:rgba(255,255,255,.9)}
.sb-lk:active{transform:translateX(3px) scale(.98)}
.sb-lk--on{background:rgba(99,102,241,.25);color:#fff;font-weight:600;transform:translateX(4px)}
.sb-lk--on::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:20px;background:var(--ac);border-radius:0 4px 4px 0;animation:barSlide .3s ease-out}
.sb-nav button:nth-child(1){animation:menuIn .3s ease-out both;animation-delay:.05s}
.sb-nav button:nth-child(2){animation:menuIn .3s ease-out both;animation-delay:.1s}
.sb-nav button:nth-child(3){animation:menuIn .3s ease-out both;animation-delay:.15s}
.sb-nav button:nth-child(4){animation:menuIn .3s ease-out both;animation-delay:.2s}
.sb-nav button:nth-child(5){animation:menuIn .3s ease-out both;animation-delay:.25s}
.sb-lk svg{width:18px;height:18px;flex-shrink:0;opacity:.7;fill:none;stroke:currentColor;stroke-width:2;transition:transform .25s ease}
.sb-lk:hover svg{transform:scale(1.15) rotate(-5deg)}
.sb-lk--on svg{opacity:1;animation:iconPop .3s ease-out}
.sb-lk .bdg{margin-left:auto;padding:2px 8px;border-radius:10px;font-size:.6875rem;font-weight:700;background:var(--err);color:#fff;line-height:1.4}
.sb-bt{margin-top:auto;padding:12px;border-top:1px solid rgba(255,255,255,.08)}
.sb-bt-c{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,.05);border-radius:var(--r);cursor:pointer;transition:var(--tr)}
.sb-bt-c:hover{background:rgba(255,255,255,.1)}
.sb-bt-av{width:34px;height:34px;border-radius:50%;background:var(--ac);display:flex;align-items:center;justify-content:center;color:#fff;font-size:.75rem;font-weight:700;flex-shrink:0}
.sb-bt-nm{font-size:.8125rem;font-weight:600;color:rgba(255,255,255,.85);line-height:1.2}
.sb-bt-em{font-size:.6875rem;color:rgba(255,255,255,.4);line-height:1.2;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:140px}
.sb-ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:29}

/* ===== Main Content ===== */
.mn{flex:1;padding:28px 32px;max-width:1200px;min-width:0;animation:fI .3s ease-out}
.ph{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:12px}
.pt{font-size:1.5rem;font-weight:800;color:var(--t1);letter-spacing:-.5px}
.bc{display:flex;align-items:center;gap:6px;font-size:.75rem;color:var(--t3);margin-bottom:4px}
.bc a{color:var(--t2);transition:color .15s;cursor:pointer}
.bc a:hover{color:var(--ac)}

/* ===== Cards ===== */
.cd{background:var(--bg-card);border-radius:var(--rl);border:1px solid var(--bd);box-shadow:0 1px 2px rgba(0,0,0,.05);transition:var(--tr)}
.cd:hover{box-shadow:var(--sh)}
.cd-b{padding:20px 24px}
.cd-h{padding:16px 24px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
.cd-h h3{font-size:1rem;font-weight:700;color:var(--t1)}

/* ===== Stats ===== */
.sr{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
.sc{background:#fff;border-radius:var(--rl);border:1px solid var(--bd);padding:20px 24px;box-shadow:0 1px 2px rgba(0,0,0,.05);transition:var(--tr);position:relative;overflow:hidden}
.sc:hover{box-shadow:var(--sh-md);transform:translateY(-2px)}
.sc::after{content:'';position:absolute;top:0;right:0;width:80px;height:80px;border-radius:50%;opacity:.06;transform:translate(20px,-20px)}
.sc:nth-child(1)::after{background:var(--ac)}
.sc:nth-child(2)::after{background:var(--ok)}
.sc:nth-child(3)::after{background:var(--wn)}
.sc:nth-child(4)::after{background:var(--pu)}
.sc-t{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.sc-lb{font-size:.75rem;font-weight:600;color:var(--t2);text-transform:uppercase;letter-spacing:.5px}
.sc-ic{width:40px;height:40px;border-radius:var(--r);display:flex;align-items:center;justify-content:center}
.sc-ic svg{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2}
.sc-ic--a{background:var(--ac-l);color:var(--ac)}
.sc-ic--o{background:var(--ok-l);color:var(--ok)}
.sc-ic--w{background:var(--wn-l);color:var(--wn)}
.sc-ic--p{background:#ede9fe;color:var(--pu)}
.sc-v{font-size:1.75rem;font-weight:800;color:var(--t1);letter-spacing:-1px;line-height:1}
.sc-ch{display:inline-flex;align-items:center;gap:3px;font-size:.75rem;font-weight:600;margin-top:8px;padding:2px 8px;border-radius:20px;background:var(--ok-l);color:#065f46}

/* ===== Dashboard Grid ===== */
.dg{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.rl{display:flex;flex-direction:column;gap:2px}
.rr{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--r);transition:var(--tr);cursor:pointer}
.rr:hover{background:var(--bg-input)}
.rd{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.rd--a{background:var(--ac)}.rd--o{background:var(--ok)}.rd--w{background:var(--wn)}.rd--e{background:var(--err)}
.ri{flex:1;min-width:0}
.ri-t{font-size:.8125rem;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ri-s{font-size:.75rem;color:var(--t3);margin-top:1px}
.ri-tm{font-size:.6875rem;color:var(--t3);white-space:nowrap}
.qg{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.qc{display:flex;flex-direction:column;align-items:center;gap:8px;padding:20px 12px;background:var(--bg-input);border:1px solid var(--bd);border-radius:var(--rl);transition:var(--tr);cursor:pointer}
.qc:hover{border-color:var(--ac);background:var(--ac-l);transform:translateY(-2px);box-shadow:var(--sh-md)}
.qc-i{width:44px;height:44px;border-radius:var(--r);display:flex;align-items:center;justify-content:center}
.qc-i svg{width:22px;height:22px;fill:none;stroke:currentColor;stroke-width:2}
.qc span{font-size:.75rem;font-weight:600;color:var(--t2)}
.qc:hover span{color:var(--ac)}

/* ===== Buttons ===== */
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--r);font-size:.8125rem;font-weight:600;transition:var(--tr);white-space:nowrap}
.btn:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}
.btn svg{width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2}
.btn-p{background:var(--ac);color:#fff;box-shadow:0 1px 2px rgba(99,102,241,.3)}
.btn-p:hover{background:var(--ac-d);box-shadow:0 4px 12px rgba(99,102,241,.3);transform:translateY(-1px)}
.btn-o{background:#fff;color:var(--t2);border:1px solid var(--bd)}
.btn-o:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-l)}
.btn-d{background:var(--err);color:#fff}
.btn-d:hover{background:#dc2626}
.bi{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;color:var(--t3);transition:var(--tr)}
.bi:hover{background:var(--bg-input);color:var(--t1)}
.bi svg{width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2}
.bi-e{color:var(--ac)}.bi-e:hover{background:var(--ac-l)}
.bi-d{color:var(--err)}.bi-d:hover{background:var(--err-l)}

/* ===== Notices ===== */
.nl{display:flex;flex-direction:column;gap:12px}
.nc{background:#fff;border:1px solid var(--bd);border-radius:var(--rl);padding:20px 24px;box-shadow:0 1px 2px rgba(0,0,0,.05);transition:var(--tr)}
.nc:hover{box-shadow:var(--sh-md)}
.nc-top{display:flex;justify-content:space-between;align-items:flex-start}
.nc-body{flex:1;min-width:0}
.nc-tl{font-size:1.0625rem;font-weight:700;color:var(--t1);margin-bottom:6px}
.nc-ct{font-size:.8125rem;color:var(--t2);line-height:1.7;white-space:pre-wrap}
.nc-act{display:flex;gap:4px;flex-shrink:0;margin-left:12px}
.nc-mt{display:flex;align-items:center;gap:16px;font-size:.75rem;color:var(--t3);margin-top:16px;padding-top:12px;border-top:1px solid var(--bd)}
.nc-mt span{display:flex;align-items:center;gap:4px}
.nc-mt svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2}
.es{text-align:center;padding:60px 24px}
.es svg{width:56px;height:56px;color:var(--t3);margin:0 auto 12px;fill:none;stroke:currentColor;stroke-width:1.5}
.es p{font-size:1rem;font-weight:600;color:var(--t2)}
.es span{font-size:.8125rem;color:var(--t3);display:block;margin-top:4px}

/* ===== Modal ===== */
.mo{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50;animation:fI .15s ease-out;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}
.mo-bx{width:100%;max-width:560px;background:#fff;border-radius:var(--rxl);box-shadow:var(--sh-xl);animation:sD .2s ease-out;overflow:hidden}
.mo-hd{padding:20px 24px;border-bottom:1px solid var(--bd);display:flex;justify-content:space-between;align-items:center}
.mo-hd h3{font-size:1.125rem;font-weight:700}
.mo-bd{padding:24px;max-height:60vh;overflow-y:auto}
.mo-ft{padding:16px 24px;border-top:1px solid var(--bd);display:flex;justify-content:flex-end;gap:8px;background:var(--bg-input)}
.fg{margin-bottom:16px}.fg:last-child{margin-bottom:0}
.fl{display:block;font-size:.8125rem;font-weight:600;color:var(--t1);margin-bottom:6px}
.fi{width:100%;padding:10px 14px;background:var(--bg-input);border:1px solid var(--bd);border-radius:var(--r);font-size:.8125rem;color:var(--t1);transition:var(--tr)}
.fi::placeholder{color:var(--t3)}
.fi:focus{border-color:var(--bd-focus);background:#fff;box-shadow:0 0 0 3px rgba(99,102,241,.1)}
textarea.fi{resize:vertical;min-height:140px;line-height:1.7}
select.fi{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10l-5 5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center}

/* ===== Dining ===== */
.db{background:linear-gradient(135deg,#ea580c,#dc2626,#db2777);border-radius:var(--rxl);padding:28px 32px;color:#fff;margin-bottom:24px;position:relative;overflow:hidden}
.db::before{content:'';position:absolute;top:-40%;right:-10%;width:250px;height:250px;background:rgba(255,255,255,.07);border-radius:50%}
.db h2{font-size:1.5rem;font-weight:800;position:relative;z-index:1}
.db p{font-size:.875rem;opacity:.85;position:relative;z-index:1;margin-top:4px}
.dg2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
.fgr{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.fc{display:flex;flex-direction:column;align-items:center;gap:6px;padding:14px 8px;background:#fff;border:2px solid var(--bd);border-radius:var(--rl);cursor:pointer;transition:var(--tr);font-size:.75rem;font-weight:500;color:var(--t2)}
.fc:hover{border-color:var(--or);color:var(--or);transform:translateY(-2px)}
.fc--on{border-color:var(--or);background:#fff7ed;color:var(--or);font-weight:700;box-shadow:0 4px 12px rgba(249,115,22,.15)}
.fc-i{font-size:1.5rem;line-height:1}.fc-n{line-height:1.2;text-align:center}
.pb{display:flex;gap:8px;flex-wrap:wrap}
.pp{padding:8px 16px;background:#fff;border:2px solid var(--bd);border-radius:var(--r);font-size:.8125rem;font-weight:500;color:var(--t2);transition:var(--tr);cursor:pointer}
.pp:hover{border-color:var(--ac);color:var(--ac)}
.pp--on{border-color:var(--ac);background:var(--ac-l);color:var(--ac);font-weight:700}
.dsb{width:100%;padding:14px;background:linear-gradient(135deg,#ea580c,#dc2626);border-radius:var(--rl);color:#fff;font-size:1rem;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 15px rgba(234,88,12,.3);transition:var(--tr);margin-top:20px}
.dsb:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(234,88,12,.4)}
.dsb:disabled{opacity:.5;transform:none}
.dsb svg{width:20px;height:20px;fill:none;stroke:currentColor;stroke-width:2}

/* ===== Dining Log ===== */
.dlc{margin-top:24px}.dlh{display:flex;justify-content:space-between;align-items:center}
.dls{display:flex;gap:16px;margin:16px 0}
.dls-i{padding:12px 20px;background:var(--bg-input);border-radius:var(--r);text-align:center;flex:1}
.dls-v{font-size:1.25rem;font-weight:800;color:var(--t1)}
.dls-l{font-size:.6875rem;color:var(--t3);margin-top:2px}
.dlf{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.dlf-i{padding:5px 12px;border-radius:20px;font-size:.75rem;font-weight:600;background:var(--bg-input);color:var(--t2);transition:var(--tr);cursor:pointer;border:1px solid transparent}
.dlf-i:hover{border-color:var(--ac);color:var(--ac)}
.dlf-i--on{background:var(--ac);color:#fff;border-color:var(--ac)}
.dll{display:flex;flex-direction:column;gap:10px}
.dli{display:flex;align-items:center;gap:14px;padding:14px 18px;background:var(--bg-input);border-radius:var(--rl);transition:var(--tr)}
.dli:hover{background:#fff;box-shadow:var(--sh)}
.dli-e{font-size:1.5rem;flex-shrink:0}
.dli-inf{flex:1;min-width:0}
.dli-nm{font-size:.875rem;font-weight:700;color:var(--t1)}
.dli-mt{font-size:.75rem;color:var(--t3);margin-top:2px;display:flex;gap:10px;flex-wrap:wrap}
.dli-st{color:var(--wn);font-size:.75rem;letter-spacing:1px}
.dli-act{display:flex;gap:4px;flex-shrink:0}
.dli-nv{padding:4px 10px;border-radius:20px;background:#03c75a;color:#fff;font-size:.6875rem;font-weight:700;transition:var(--tr);cursor:pointer;border:none}
.dli-nv:hover{background:#02b351}
.dle{text-align:center;padding:40px 20px;color:var(--t3)}.dle p{font-size:.875rem}

/* ===== Calendar ===== */
.cal-auth{text-align:center;padding:60px 24px}
.cal-auth p{color:var(--t2);margin-bottom:20px;font-size:.9375rem}
.cal-auth-btn{padding:14px 32px;background:var(--ac);color:#fff;border-radius:var(--rl);font-size:.9375rem;font-weight:700;display:inline-flex;align-items:center;gap:10px;box-shadow:0 4px 15px rgba(99,102,241,.3);transition:var(--tr)}
.cal-auth-btn:hover{background:var(--ac-d);transform:translateY(-2px);box-shadow:0 8px 25px rgba(99,102,241,.4)}
.cal-auth-btn svg{width:20px;height:20px}
.cal-hd{display:flex;align-items:center;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.cal-title{font-size:1.25rem;font-weight:800;color:var(--t1);min-width:140px;text-align:center}
.cal-nav{width:36px;height:36px;border-radius:var(--r);display:flex;align-items:center;justify-content:center;background:var(--bg-input);border:1px solid var(--bd);color:var(--t2);font-size:1rem;transition:var(--tr)}
.cal-nav:hover{background:var(--ac-l);color:var(--ac);border-color:var(--ac)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);border:1px solid var(--bd);border-radius:var(--rl);overflow:hidden;background:var(--bd)}
.cal-dh{padding:10px 4px;text-align:center;font-size:.6875rem;font-weight:700;color:var(--t2);background:var(--bg-input);text-transform:uppercase}
.cal-dh:first-child{color:var(--err)}.cal-dh:last-child{color:var(--ac)}
.cal-cell{background:#fff;min-height:100px;padding:6px;cursor:pointer;transition:background .15s}
.cal-cell:hover{background:var(--ac-l)}
.cal-cell--out{background:var(--bg-input);opacity:.5}
.cal-cell--today{background:#eef2ff;box-shadow:inset 0 0 0 2px var(--ac)}
.cal-dt{font-size:.75rem;font-weight:700;color:var(--t1);margin-bottom:4px;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%}
.cal-cell--today .cal-dt{background:var(--ac);color:#fff}
.cal-evt{font-size:.625rem;padding:2px 4px;border-radius:3px;background:var(--ac-l);color:var(--ac-d);font-weight:600;margin-bottom:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer;transition:var(--tr)}
.cal-evt:hover{background:var(--ac);color:#fff}
.cal-more{font-size:.6rem;color:var(--t3);text-align:center;margin-top:2px}
.cal-upcoming{margin-top:24px}
.cal-upcoming h3{font-size:1rem;font-weight:700;margin-bottom:12px}
.cal-up-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-input);border-radius:var(--r);margin-bottom:8px;cursor:pointer;transition:var(--tr)}
.cal-up-item:hover{background:#fff;box-shadow:var(--sh)}
.cal-up-dot{width:8px;height:8px;border-radius:50%;background:var(--ac);flex-shrink:0}
.cal-up-info{flex:1;min-width:0}
.cal-up-title{font-size:.8125rem;font-weight:600;color:var(--t1)}
.cal-up-time{font-size:.75rem;color:var(--t3);margin-top:2px}

/* ===== Chatbot ===== */
#cb{position:fixed;bottom:24px;right:24px;z-index:9990;display:flex;flex-direction:column;align-items:flex-end}
.cb-f{width:56px;height:56px;border-radius:50%;background:var(--ac);color:#fff;box-shadow:0 4px 20px rgba(99,102,241,.4);font-size:1.25rem;display:flex;align-items:center;justify-content:center;transition:var(--tr);animation:fp 3s ease-in-out infinite;position:relative}
.cb-f:hover{transform:scale(1.1);box-shadow:0 8px 30px rgba(99,102,241,.5)}
.cb-tp{position:absolute;right:calc(100% + 12px);top:50%;transform:translateY(-50%);background:var(--bg-side);color:#fff;padding:8px 14px;border-radius:var(--r);font-size:.75rem;font-weight:500;white-space:nowrap;box-shadow:var(--sh-lg);animation:fI .3s;pointer-events:none}
.cb-tp::after{content:'';position:absolute;top:50%;right:-6px;transform:translateY(-50%);border:6px solid transparent;border-left-color:var(--bg-side)}
.cb-w{width:400px;max-height:580px;background:#fff;border-radius:var(--rxl);box-shadow:var(--sh-xl);border:1px solid var(--bd);display:none;flex-direction:column;overflow:hidden;margin-bottom:10px;animation:sU .25s ease-out}
.cb-w--o{display:flex}
.cb-hd{padding:16px 20px;background:var(--ac);color:#fff;display:flex;justify-content:space-between;align-items:center;flex-shrink:0}
.cb-hd-l{display:flex;align-items:center;gap:10px}
.cb-hd-av{width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:1rem}
.cb-hd-i h4{font-size:.875rem;font-weight:700}
.cb-hd-i span{font-size:.6875rem;opacity:.8;display:flex;align-items:center;gap:4px}
.cb-hd-i span::before{content:'';width:6px;height:6px;border-radius:50%;background:#4ade80}
.cb-cl{color:#fff;font-size:1.25rem;padding:4px 8px;border-radius:6px;cursor:pointer;transition:var(--tr)}
.cb-cl:hover{background:rgba(255,255,255,.15)}
.cb-ms{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:8px;max-height:340px;min-height:240px;scrollbar-width:thin;scrollbar-color:var(--bd) transparent}
.cb-ms::-webkit-scrollbar{width:4px}
.cb-ms::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}
.cb-m{max-width:85%;animation:sU .2s ease-out}
.cb-m--b{align-self:flex-start}.cb-m--u{align-self:flex-end}
.cb-bb{padding:10px 14px;border-radius:var(--rl);font-size:.8125rem;line-height:1.65;word-break:break-word}
.cb-m--b .cb-bb{background:var(--bg-input);color:var(--t1);border-bottom-left-radius:4px}
.cb-m--u .cb-bb{background:var(--ac);color:#fff;border-bottom-right-radius:4px}
.cb-tm{font-size:.625rem;color:var(--t3);margin-top:2px;padding:0 4px}
.cb-m--u .cb-tm{text-align:right}
.cb-bb b{font-weight:700}
.cb-ty{align-self:flex-start;display:flex;gap:4px;padding:10px 14px}
.cb-ty span{width:7px;height:7px;border-radius:50%;background:var(--t3);animation:dB 1.4s infinite}
.cb-ty span:nth-child(2){animation-delay:.2s}
.cb-ty span:nth-child(3){animation-delay:.4s}
.cb-sg{display:flex;flex-wrap:wrap;gap:6px;padding:10px 16px;border-top:1px solid var(--bd);background:var(--bg-input);flex-shrink:0}
.cb-sg-b{padding:5px 12px;background:#fff;border:1px solid var(--bd);border-radius:20px;font-size:.6875rem;color:var(--t2);font-weight:500;transition:var(--tr);cursor:pointer}
.cb-sg-b:hover{border-color:var(--ac);color:var(--ac);background:var(--ac-l)}
.cb-ia{padding:12px;border-top:1px solid var(--bd);display:flex;gap:8px;background:#fff;flex-shrink:0}
.cb-in{flex:1;padding:10px 14px;border:1.5px solid var(--bd);border-radius:var(--r);font-size:.8125rem;background:var(--bg-input);transition:var(--tr)}
.cb-in:focus{border-color:var(--ac);background:#fff}
.cb-sn{padding:10px 16px;background:var(--ac);color:#fff;border-radius:var(--r);font-size:.8125rem;font-weight:600;transition:var(--tr);display:flex;align-items:center;gap:4px;cursor:pointer}
.cb-sn:hover{background:var(--ac-d);box-shadow:0 2px 8px rgba(99,102,241,.3)}
.cb-sn:disabled{opacity:.4;cursor:not-allowed}
.cb-sn svg{width:14px;height:14px;fill:none;stroke:currentColor;stroke-width:2}

/* ===== Responsive ===== */
@media(max-width:1024px){
  .sr{grid-template-columns:repeat(2,1fr)}
  .fgr{grid-template-columns:repeat(3,1fr)}
  .dg{grid-template-columns:1fr}
  .hd-search{display:none}
  .cal-cell{min-height:70px}
}
@media(max-width:768px){
  .hd-menu{display:block}
  .sb{position:fixed;top:var(--hh);left:0;bottom:0;z-index:30;transform:translateX(-100%)}
  .sb--op{transform:translateX(0)}
  .sb-ov--s{display:block}
  .mn{padding:16px}
  .sr{grid-template-columns:1fr 1fr}
  .dg2{grid-template-columns:1fr}
  .fgr{grid-template-columns:repeat(3,1fr)}
  .lp{flex-direction:column}
  .lp-l{padding:2rem;min-height:auto}
  .lp-feats{display:none}
  .lp-r{width:100%;padding:2rem}
  .lp-brand h1{font-size:2.25rem}
  .cb-w{width:calc(100vw - 32px);max-height:calc(100vh - 100px)}
  #cb{bottom:16px;right:16px}
  .hd-pi{display:none}
  .cal-cell{min-height:56px}
  .cal-evt{font-size:.55rem}
}
@media(max-width:480px){
  .sr{grid-template-columns:1fr}
  .fgr{grid-template-columns:repeat(2,1fr)}
  .pb{gap:6px}
  .pp{padding:6px 12px;font-size:.75rem}
}

/* ===== Print ===== */
@media print{
  .sb,.hd,#cb,.cb-w{display:none!important}
  .mn{padding:0;max-width:100%}
  .mo{display:none!important}
}
</style>
</head>
<body>

<!-- â•â•â• Toast â•â•â• -->
<div id="tw" class="tw" aria-live="polite"></div>

<!-- â•â•â• Login â•â•â• -->
<div id="pgLogin" class="lp">
  <div class="lp-ctr">
    <div class="lp-brand">
      <div class="lp-logo">
        <svg viewBox="0 0 48 48" width="54" height="54"><rect x="4" y="4" width="18" height="18" rx="4" fill="#6366f1"/><rect x="26" y="4" width="18" height="18" rx="4" fill="#a5b4fc"/><rect x="4" y="26" width="18" height="18" rx="4" fill="#a5b4fc"/><rect x="26" y="26" width="18" height="18" rx="4" fill="#6366f1"/></svg>
      </div>
      <h1 class="lp-title">WorkHub</h1>
      <p class="lp-sub">ê¸°ì—…ìš© ìŠ¤ë§ˆíŠ¸ ê·¸ë£¹ì›¨ì–´</p>
    </div>

    <div class="lp-features">
      <div class="lp-feat"><span class="lp-feat-icon">ğŸ“‹</span><div><strong>ê³µì§€ì‚¬í•­</strong><br>ì‹¤ì‹œê°„ ì‚¬ë‚´ ê³µì§€ ê´€ë¦¬</div></div>
      <div class="lp-feat"><span class="lp-feat-icon">ğŸ½ï¸</span><div><strong>íšŒì‹ ê´€ë¦¬</strong><br>ë§›ì§‘ ê²€ìƒ‰ &amp; íšŒì‹ ê¸°ë¡</div></div>
      <div class="lp-feat"><span class="lp-feat-icon">ğŸ“…</span><div><strong>ìº˜ë¦°ë”</strong><br>Google ìº˜ë¦°ë” ì—°ë™ ì¼ì • ê´€ë¦¬</div></div>
      <div class="lp-feat"><span class="lp-feat-icon">ğŸ¤–</span><div><strong>AI ì–´ì‹œìŠ¤í„´íŠ¸</strong><br>ìì—°ì–´ ì—…ë¬´ ë„ìš°ë¯¸</div></div>
    </div>

    <button class="lp-btn" onclick="App.auth.loginGoogle()">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59A14.5 14.5 0 0 1 9.5 24c0-1.59.28-3.14.76-4.59l-7.98-6.19A23.97 23.97 0 0 0 0 24c0 3.77.9 7.35 2.56 10.52l7.97-5.93z"/><path fill="#34A853" d="M24 48c6.47 0 11.9-2.13 15.87-5.78l-7.73-6c-2.15 1.45-4.92 2.3-8.14 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 5.93C6.51 42.62 14.62 48 24 48z"/></svg>
      Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
    </button>

    <p class="lp-footer">WorkHub v3.0 &mdash; Powered by Firebase &amp; Google Calendar</p>
  </div>
</div>

<!-- â•â•â• App Shell â•â•â• -->
<div id="app" hidden>

  <!-- Header -->
  <header class="hd">
    <button class="hd-menu" onclick="App.ui.toggleSB()" aria-label="ë©”ë‰´ ì—´ê¸°">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="hd-logo">
      <svg viewBox="0 0 48 48" width="28" height="28"><rect x="4" y="4" width="18" height="18" rx="4" fill="#6366f1"/><rect x="26" y="4" width="18" height="18" rx="4" fill="#a5b4fc"/><rect x="4" y="26" width="18" height="18" rx="4" fill="#a5b4fc"/><rect x="26" y="26" width="18" height="18" rx="4" fill="#6366f1"/></svg>
      <span class="hd-logo-txt">WorkHub</span>
    </div>
    <div class="hd-spacer"></div>

    <!-- search -->
    <div class="hd-search">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="#94a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input id="hSearch" class="hd-search-in" placeholder="ê²€ìƒ‰ (Ctrl+K)" autocomplete="off">
    </div>

    <!-- notification -->
    <button class="hd-icon-btn" id="hNoti" onclick="App.ui.toggleNoti()" aria-label="ì•Œë¦¼">
      <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
      <span class="hd-badge" id="hBadge" hidden></span>
    </button>

    <!-- profile -->
    <div class="hd-prof" onclick="App.ui.toggleProf()">
      <div class="hd-av" id="hAv">W</div>
    </div>
  </header>

  <!-- Notification dropdown -->
  <div id="notiDrop" class="noti-drop" hidden>
    <div class="noti-head"><strong>ì•Œë¦¼</strong><button class="noti-clear" onclick="App.ui.clearNoti()">ëª¨ë‘ ì½ìŒ</button></div>
    <div id="notiList" class="noti-list"><p class="noti-empty">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p></div>
  </div>

  <!-- Profile dropdown -->
  <div id="profDrop" class="prof-drop" hidden>
    <div class="prof-info">
      <div class="prof-av" id="pAv">W</div>
      <div><div class="prof-nm" id="pNm">ì‚¬ìš©ì</div><div class="prof-em" id="pEm">email</div></div>
    </div>
    <div class="prof-divider"></div>
    <button class="prof-btn" onclick="App.auth.logout()">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      ë¡œê·¸ì•„ì›ƒ
    </button>
  </div>

  <!-- Sidebar -->
  <aside id="sb" class="sb">
    <nav class="sb-nav">
      <a class="sb-lk sb-lk--on" data-pg="dash" onclick="App.rt.go('dash')">
        <svg class="sb-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
        <span>ëŒ€ì‹œë³´ë“œ</span>
      </a>
      <a class="sb-lk" data-pg="notices" onclick="App.rt.go('notices')">
        <svg class="sb-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        <span>ê³µì§€ì‚¬í•­</span>
      </a>
      <a class="sb-lk" data-pg="dining" onclick="App.rt.go('dining')">
        <svg class="sb-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>
        <span>íšŒì‹ ê´€ë¦¬</span>
      </a>
      <a class="sb-lk" data-pg="calendar" onclick="App.rt.go('calendar')">
        <svg class="sb-ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
        <span>ìº˜ë¦°ë”</span>
      </a>
    </nav>
  </aside>

  <!-- Sidebar overlay (mobile) -->
  <div id="sbOv" class="sb-ov" onclick="App.ui.toggleSB()" hidden></div>

  <!-- â•â•â• Main Content â•â•â• -->
  <main class="mn">

    <!-- â”€â”€ Dashboard â”€â”€ -->
    <section id="pgDash" class="pg pg--on">
      <div class="pg-hd">
        <h2 class="pg-title">ëŒ€ì‹œë³´ë“œ</h2>
        <p class="pg-sub" id="dashGreet">í™˜ì˜í•©ë‹ˆë‹¤!</p>
      </div>

      <!-- stats -->
      <div class="stats" id="dashStats">
        <div class="stat-card">
          <div class="stat-icon stat-icon--indigo">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <div class="stat-info"><div class="stat-num" id="dsNotice">0</div><div class="stat-lbl">ê³µì§€ì‚¬í•­</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon stat-icon--emerald">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/></svg>
          </div>
          <div class="stat-info"><div class="stat-num" id="dsDining">0</div><div class="stat-lbl">íšŒì‹ ê¸°ë¡</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon stat-icon--amber">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          </div>
          <div class="stat-info"><div class="stat-num" id="dsEvent">0</div><div class="stat-lbl">ì˜ˆì • ì¼ì •</div></div>
        </div>
        <div class="stat-card">
          <div class="stat-icon stat-icon--rose">
            <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </div>
          <div class="stat-info"><div class="stat-num" id="dsCost">â‚©0</div><div class="stat-lbl">íšŒì‹ ì´ì•¡</div></div>
        </div>
      </div>

      <!-- dashboard grid -->
      <div class="dash-grid">
        <div class="card">
          <div class="card-hd"><h3>ìµœê·¼ ê³µì§€</h3><a class="card-more" onclick="App.rt.go('notices')">ì „ì²´ë³´ê¸° â†’</a></div>
          <div id="dashNotices" class="card-body"><div class="skel-list"><div class="skel-line"></div><div class="skel-line skel-line--short"></div><div class="skel-line"></div></div></div>
        </div>
        <div class="card">
          <div class="card-hd"><h3>ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</h3><a class="card-more" onclick="App.rt.go('calendar')">ì „ì²´ë³´ê¸° â†’</a></div>
          <div id="dashEvents" class="card-body"><div class="skel-list"><div class="skel-line"></div><div class="skel-line skel-line--short"></div><div class="skel-line"></div></div></div>
        </div>
        <div class="card">
          <div class="card-hd"><h3>ìµœê·¼ íšŒì‹</h3><a class="card-more" onclick="App.rt.go('dining')">ì „ì²´ë³´ê¸° â†’</a></div>
          <div id="dashDining" class="card-body"><div class="skel-list"><div class="skel-line"></div><div class="skel-line skel-line--short"></div><div class="skel-line"></div></div></div>
        </div>
      </div>
    </section>

    <!-- â”€â”€ Notices â”€â”€ -->
    <section id="pgNotices" class="pg">
      <div class="pg-hd">
        <h2 class="pg-title">ê³µì§€ì‚¬í•­</h2>
        <button class="btn btn--primary" onclick="App.notice.openNew()">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          ìƒˆ ê³µì§€
        </button>
      </div>
      <div class="notice-filters">
        <button class="chip chip--on" data-nf="all" onclick="App.notice.filter('all')">ì „ì²´</button>
        <button class="chip" data-nf="normal" onclick="App.notice.filter('normal')">ì¼ë°˜</button>
        <button class="chip" data-nf="important" onclick="App.notice.filter('important')">ì¤‘ìš”</button>
        <button class="chip" data-nf="urgent" onclick="App.notice.filter('urgent')">ê¸´ê¸‰</button>
      </div>
      <div id="noticeList" class="notice-list"><div class="skel-list"><div class="skel-line"></div><div class="skel-line skel-line--short"></div><div class="skel-line"></div><div class="skel-line skel-line--short"></div></div></div>
    </section>

    <!-- â”€â”€ Dining â”€â”€ -->
    <section id="pgDining" class="pg">
      <div class="pg-hd">
        <h2 class="pg-title">íšŒì‹ ê´€ë¦¬</h2>
      </div>

      <!-- dining finder -->
      <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-hd"><h3>ğŸ½ï¸ ë§›ì§‘ ê²€ìƒ‰</h3></div>
        <div class="card-body">
          <div class="din-row">
            <div class="din-field">
              <label class="din-label">ì§€ì—­</label>
              <select id="dinArea" class="din-sel">
                <option value="">ì„ íƒ</option>
                <option>ê°•ë‚¨</option><option>í™ëŒ€</option><option>ì´íƒœì›</option><option>ì¢…ë¡œ</option>
                <option>ì—¬ì˜ë„</option><option>ë§ˆí¬</option><option>ì„±ìˆ˜</option><option>ì„ì§€ë¡œ</option>
                <option>ì‹ ì´Œ</option><option>ì••êµ¬ì •</option><option>ì ì‹¤</option><option>ê±´ëŒ€</option>
              </select>
            </div>
            <div class="din-field">
              <label class="din-label">ì¸ì›</label>
              <select id="dinPpl" class="din-sel">
                <option value="">ì„ íƒ</option>
                <option>2~4ëª…</option><option>5~8ëª…</option><option>9~15ëª…</option><option>16~20ëª…</option><option>20ëª…+</option>
              </select>
            </div>
          </div>
          <label class="din-label" style="margin-top:.75rem;">ìŒì‹ ì¢…ë¥˜</label>
          <div class="food-grid" id="foodGrid">
            <button class="food-chip" data-food="í•œì‹">ğŸš í•œì‹</button>
            <button class="food-chip" data-food="ì¤‘ì‹">ğŸ¥¡ ì¤‘ì‹</button>
            <button class="food-chip" data-food="ì¼ì‹">ğŸ£ ì¼ì‹</button>
            <button class="food-chip" data-food="ì–‘ì‹">ğŸ ì–‘ì‹</button>
            <button class="food-chip" data-food="ê³ ê¸°/BBQ">ğŸ¥© ê³ ê¸°/BBQ</button>
            <button class="food-chip" data-food="ì¹˜í‚¨/í˜¸í”„">ğŸ— ì¹˜í‚¨/í˜¸í”„</button>
            <button class="food-chip" data-food="í•´ì‚°ë¬¼">ğŸ¦ í•´ì‚°ë¬¼</button>
            <button class="food-chip" data-food="ë¶„ì‹">ğŸœ ë¶„ì‹</button>
            <button class="food-chip" data-food="ì¹´í˜/ë””ì €íŠ¸">â˜• ì¹´í˜/ë””ì €íŠ¸</button>
            <button class="food-chip" data-food="ë·”í˜">ğŸ± ë·”í˜</button>
          </div>
          <button class="btn btn--primary" style="width:100%;margin-top:1rem;" onclick="App.din.search()">
            <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            ë§›ì§‘ ê²€ìƒ‰
          </button>
        </div>
      </div>

      <!-- map result -->
      <div id="dinResult" class="card" hidden>
        <div class="card-hd"><h3>ê²€ìƒ‰ ê²°ê³¼</h3><button class="btn btn--ghost btn--sm" onclick="$('dinResult').hidden=true">ë‹«ê¸°</button></div>
        <div class="card-body" id="dinMap" style="height:450px;position:relative;overflow:hidden;"></div>
      </div>

      <!-- dining log -->
      <div class="card" style="margin-top:1.5rem;">
        <div class="card-hd">
          <h3>íšŒì‹ ê¸°ë¡</h3>
          <button class="btn btn--primary btn--sm" onclick="App.dl.openNew()">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            ê¸°ë¡ ì¶”ê°€
          </button>
        </div>
        <div id="dlStats" class="dl-stats"></div>
        <div id="dlList" class="card-body"><div class="skel-list"><div class="skel-line"></div><div class="skel-line skel-line--short"></div></div></div>
      </div>
    </section>

    <!-- â”€â”€ Calendar â”€â”€ -->
    <section id="pgCalendar" class="pg">
      <div class="pg-hd">
        <h2 class="pg-title">ìº˜ë¦°ë”</h2>
        <button class="btn btn--primary" onclick="App.cal.openNew()">
          <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          ì¼ì • ì¶”ê°€
        </button>
      </div>

      <!-- Google Calendar auth box -->
      <div id="calAuth" class="cal-auth">
        <div class="cal-auth-inner">
          <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#6366f1" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          <h3 style="margin:.75rem 0 .25rem">Google ìº˜ë¦°ë” ì—°ë™</h3>
          <p style="color:#64748b;font-size:.9rem;margin-bottom:1rem">Google ìº˜ë¦°ë”ì™€ ì—°ë™í•˜ì—¬ ì¼ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
          <button class="btn btn--primary" onclick="App.cal.authorize()">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59A14.5 14.5 0 0 1 9.5 24c0-1.59.28-3.14.76-4.59l-7.98-6.19A23.97 23.97 0 0 0 0 24c0 3.77.9 7.35 2.56 10.52l7.97-5.93z"/><path fill="#34A853" d="M24 48c6.47 0 11.9-2.13 15.87-5.78l-7.73-6c-2.15 1.45-4.92 2.3-8.14 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 5.93C6.51 42.62 14.62 48 24 48z"/></svg>
            Google ìº˜ë¦°ë” ì—°ë™í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- Calendar UI (hidden until linked) -->
      <div id="calUI" hidden>
        <div class="cal-toolbar">
          <button class="btn btn--ghost btn--sm" onclick="App.cal.prev()">â—€</button>
          <h3 class="cal-month" id="calMonth"></h3>
          <button class="btn btn--ghost btn--sm" onclick="App.cal.next()">â–¶</button>
          <button class="btn btn--ghost btn--sm" style="margin-left:auto" onclick="App.cal.today()">ì˜¤ëŠ˜</button>
        </div>
        <div class="cal-grid" id="calGrid"></div>
        <div class="card" style="margin-top:1.5rem">
          <div class="card-hd"><h3>ë‹¤ê°€ì˜¤ëŠ” ì¼ì •</h3></div>
          <div id="calUpcoming" class="card-body"></div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- â•â•â• Modals â•â•â• -->

<!-- Notice Modal -->
<div id="mN" class="modal-ov" hidden>
  <div class="modal">
    <div class="modal-hd">
      <h3 id="mNTitle">ìƒˆ ê³µì§€</h3>
      <button class="modal-close" onclick="$('mN').hidden=true">&times;</button>
    </div>
    <div class="modal-body">
      <label class="field-label">ì œëª©</label>
      <input id="nTitle" class="field-input" placeholder="ê³µì§€ ì œëª©">
      <label class="field-label">ë‚´ìš©</label>
      <textarea id="nBody" class="field-textarea" rows="5" placeholder="ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <label class="field-label">ì¤‘ìš”ë„</label>
      <select id="nPri" class="field-select">
        <option value="normal">ì¼ë°˜</option>
        <option value="important">ì¤‘ìš”</option>
        <option value="urgent">ê¸´ê¸‰</option>
      </select>
    </div>
    <div class="modal-ft">
      <button class="btn btn--ghost" onclick="$('mN').hidden=true">ì·¨ì†Œ</button>
      <button class="btn btn--primary" id="nSaveBtn" onclick="App.notice.save()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Dining Log Modal -->
<div id="mDL" class="modal-ov" hidden>
  <div class="modal">
    <div class="modal-hd">
      <h3 id="mDLTitle">íšŒì‹ ê¸°ë¡</h3>
      <button class="modal-close" onclick="$('mDL').hidden=true">&times;</button>
    </div>
    <div class="modal-body">
      <label class="field-label">ì‹ë‹¹ëª…</label>
      <input id="dlName" class="field-input" placeholder="ì‹ë‹¹ ì´ë¦„">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
        <div><label class="field-label">ì§€ì—­</label><input id="dlArea" class="field-input" placeholder="ì˜ˆ: ê°•ë‚¨"></div>
        <div><label class="field-label">ìŒì‹ ì¢…ë¥˜</label><input id="dlFood" class="field-input" placeholder="ì˜ˆ: í•œì‹"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
        <div><label class="field-label">ì¸ì›</label><input id="dlPpl" class="field-input" type="number" min="1" placeholder="ëª…"></div>
        <div><label class="field-label">ë¹„ìš© (ì›)</label><input id="dlCost" class="field-input" type="number" min="0" placeholder="ì´ ë¹„ìš©"></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
        <div><label class="field-label">ë‚ ì§œ</label><input id="dlDate" class="field-input" type="date"></div>
        <div><label class="field-label">í‰ì </label>
          <select id="dlRate" class="field-select"><option value="5">â­â­â­â­â­ (5)</option><option value="4">â­â­â­â­ (4)</option><option value="3">â­â­â­ (3)</option><option value="2">â­â­ (2)</option><option value="1">â­ (1)</option></select>
        </div>
      </div>
      <label class="field-label">ë©”ëª¨</label>
      <textarea id="dlMemo" class="field-textarea" rows="2" placeholder="í•œì¤„ ë©”ëª¨"></textarea>
    </div>
    <div class="modal-ft">
      <button class="btn btn--ghost" onclick="$('mDL').hidden=true">ì·¨ì†Œ</button>
      <button class="btn btn--danger" id="dlDelBtn" onclick="App.dl.del()" hidden>ì‚­ì œ</button>
      <button class="btn btn--primary" onclick="App.dl.save()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Calendar Event Modal -->
<div id="mCE" class="modal-ov" hidden>
  <div class="modal">
    <div class="modal-hd">
      <h3 id="mCETitle">ì¼ì • ì¶”ê°€</h3>
      <button class="modal-close" onclick="$('mCE').hidden=true">&times;</button>
    </div>
    <div class="modal-body">
      <label class="field-label">ì œëª©</label>
      <input id="ceTitle" class="field-input" placeholder="ì¼ì • ì œëª©">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem">
        <div><label class="field-label">ì‹œì‘</label><input id="ceStart" class="field-input" type="datetime-local"></div>
        <div><label class="field-label">ì¢…ë£Œ</label><input id="ceEnd" class="field-input" type="datetime-local"></div>
      </div>
      <label class="field-label">ì¥ì†Œ</label>
      <input id="ceLoc" class="field-input" placeholder="ì¥ì†Œ (ì„ íƒ)">
      <label class="field-label">ì„¤ëª…</label>
      <textarea id="ceDesc" class="field-textarea" rows="3" placeholder="ì„¤ëª… (ì„ íƒ)"></textarea>
      <label class="field-label">ì•Œë¦¼ (ë¶„ ì „)</label>
      <select id="ceRemind" class="field-select">
        <option value="10">10ë¶„ ì „</option>
        <option value="30" selected>30ë¶„ ì „</option>
        <option value="60">1ì‹œê°„ ì „</option>
        <option value="1440">1ì¼ ì „</option>
        <option value="">ì—†ìŒ</option>
      </select>
    </div>
    <div class="modal-ft">
      <button class="btn btn--ghost" onclick="$('mCE').hidden=true">ì·¨ì†Œ</button>
      <button class="btn btn--danger" id="ceDelBtn" onclick="App.cal.deleteEvent()" hidden>ì‚­ì œ</button>
      <button class="btn btn--primary" onclick="App.cal.saveEvent()">ì €ì¥</button>
    </div>
  </div>
</div>

<!-- Confirm Modal -->
<div id="mCf" class="modal-ov" hidden>
  <div class="modal modal--sm">
    <div class="modal-body" style="text-align:center;padding:2rem">
      <p id="cfMsg" style="font-size:1.05rem;margin-bottom:1.5rem">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
      <div style="display:flex;gap:.75rem;justify-content:center">
        <button class="btn btn--ghost" onclick="$('mCf').hidden=true">ì·¨ì†Œ</button>
        <button class="btn btn--danger" id="cfOk">í™•ì¸</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• Chatbot â•â•â• -->
<button class="chat-fab" id="chatFab" onclick="App.chat.toggle()" aria-label="AI ì–´ì‹œìŠ¤í„´íŠ¸">
  <svg viewBox="0 0 24 24" width="26" height="26" fill="none" stroke="#fff" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
</button>

<div id="chatPanel" class="chat-panel" hidden>
  <div class="chat-hd">
    <div><strong>AI ì–´ì‹œìŠ¤í„´íŠ¸</strong><span class="chat-badge">Beta</span></div>
    <button class="chat-close" onclick="App.chat.toggle()">&times;</button>
  </div>
  <div id="chatMsgs" class="chat-msgs">
    <div class="chat-msg chat-msg--bot">
      <div class="chat-bubble">ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br><br>
        ğŸ’¡ <b>ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹:</b><br>
        â€¢ "ì˜¤ëŠ˜ ì¼ì •" / "ë‚´ì¼ ì¼ì •"<br>
        â€¢ "ì¼ì • ë“±ë¡" (ìì—°ì–´)<br>
        â€¢ "ê³µì§€ ì‘ì„±" / "ê³µì§€ ëª©ë¡"<br>
        â€¢ "íšŒì‹ ê²€ìƒ‰ ê°•ë‚¨ í•œì‹"<br>
        â€¢ "ëŒ€ì‹œë³´ë“œ" / "ìº˜ë¦°ë” ì—´ì–´"
      </div>
    </div>
  </div>
  <div class="chat-input">
    <input id="chatIn" class="chat-in" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if(event.key==='Enter')App.chat.send()">
    <button class="chat-send" onclick="App.chat.send()">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>
</div>

<!-- Part 3 (JavaScript) follows -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WorkHub v3.0 â€” Full JavaScript
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ helpers â”€â”€ */
const $=id=>document.getElementById(id);
const App={auth:{},ui:{},rt:{},dash:{},notice:{},din:{},dl:{},cal:{},chat:{}};

function toast(msg,type='info'){
  const tw=$('tw'),d=document.createElement('div');
  d.className='toast toast--'+type;
  d.innerHTML=`<span>${msg}</span><button class="toast-x" onclick="this.parentNode.remove()">&times;</button>`;
  tw.appendChild(d);
  setTimeout(()=>{d.style.opacity='0';d.style.transform='translateX(120%)';setTimeout(()=>d.remove(),400);},3500);
}
function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function tAgo(ts){
  if(!ts)return'';
  const s=Math.floor((Date.now()-(ts.toDate?ts.toDate():new Date(ts)).getTime())/1000);
  if(s<60)return'ë°©ê¸ˆ ì „';if(s<3600)return Math.floor(s/60)+'ë¶„ ì „';
  if(s<86400)return Math.floor(s/3600)+'ì‹œê°„ ì „';return Math.floor(s/86400)+'ì¼ ì „';
}
function fDate(d){if(!d)return'';const o=d.toDate?d.toDate():new Date(d);return o.getFullYear()+'-'+pad2(o.getMonth()+1)+'-'+pad2(o.getDate());}
function fMoney(n){return'â‚©'+Number(n||0).toLocaleString('ko-KR');}
function pad2(n){return String(n).padStart(2,'0');}
function now(){return new Date();}
function toLocalDT(d){const o=d instanceof Date?d:new Date(d);return o.getFullYear()+'-'+pad2(o.getMonth()+1)+'-'+pad2(o.getDate())+'T'+pad2(o.getHours())+':'+pad2(o.getMinutes());}

/* â”€â”€ Firebase â”€â”€ */
firebase.initializeApp({
  apiKey:"AIzaSyA0Vy3pR-sFNnxgM1F6MFWGP_0mDfpkuBo",
  authDomain:"workhub2-ad595.firebaseapp.com",
  projectId:"workhub2-ad595"
});
const db=firebase.firestore();

/* â”€â”€ Google Calendar constants â”€â”€ */
const GCAL_CID='535238333900-f0746m5heeijpb55ulhfbm2l15c57r7k.apps.googleusercontent.com';
const GCAL_KEY='AIzaSyDcHSt46CHlu_LZYnNUU7xwIlMY7xE8KdU';
const GCAL_DISC='https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
const GCAL_SCOPE='https://www.googleapis.com/auth/calendar';
let _gapiOk=false,_gisOk=false,_tokClient=null;

/* â”€â”€ Global State â”€â”€ */
const S={
  user:null,pg:'dash',
  calYear:now().getFullYear(),calMonth:now().getMonth(),
  calEvents:[],calLinked:false,editEvtId:null,
  notices:[],nFilter:'all',editNoticeId:null,
  dlList:[],editDlId:null,
  chatOpen:false,chatStep:null,chatBuf:{}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.auth.loginGoogle=function(){
  const prov=new firebase.auth.GoogleAuthProvider();
  prov.addScope('https://www.googleapis.com/auth/calendar');
  firebase.auth().signInWithPopup(prov).catch(e=>{
    console.error(e);toast('ë¡œê·¸ì¸ ì‹¤íŒ¨: '+e.message,'error');
  });
};
App.auth.logout=function(){
  firebase.auth().signOut();
  if(gapi&&gapi.client){try{google.accounts.oauth2.revoke(gapi.client.getToken()?.access_token);}catch(e){}}
};
App.auth.onUser=function(u){
  S.user=u;
  if(u){
    const nm=u.displayName||'ì‚¬ìš©ì';
    const init=nm.charAt(0).toUpperCase();
    /* header profile */
    $('hAv').textContent=init;
    /* profile dropdown */
    if($('pNm'))$('pNm').textContent=nm;
    if($('pEm'))$('pEm').textContent=u.email;
    if($('pAv'))$('pAv').textContent=init;
    /* greeting */
    const h=now().getHours();
    const greet=h<12?'ì¢‹ì€ ì•„ì¹¨ì´ì—ìš”':h<18?'ì¢‹ì€ ì˜¤í›„ì—ìš”':'ì¢‹ì€ ì €ë…ì´ì—ìš”';
    $('dashGreet').textContent=greet+', '+nm+'ë‹˜!';

    $('pgLogin').hidden=true;$('app').hidden=false;$('chatFab').style.display='';
    App.rt.go('dash');
    _tryGapiToken(u);
  }else{
    $('pgLogin').hidden=false;$('app').hidden=true;$('chatFab').style.display='none';
    S.calLinked=false;
  }
};
firebase.auth().onAuthStateChanged(App.auth.onUser);

/* try to set gapi token from Firebase credential */
function _tryGapiToken(u){
  /* if the user logged in via Google and we have the access token cached, re-use it */
  const tok=sessionStorage.getItem('gcal_tok');
  if(tok&&_gapiOk){
    gapi.client.setToken({access_token:tok});
    S.calLinked=true;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.ui.toggleSB=function(){
  const sb=$('sb'),ov=$('sbOv');
  const open=sb.classList.toggle('sb--open');
  ov.hidden=!open;
};
App.ui.toggleNoti=function(){
  $('notiDrop').hidden=!$('notiDrop').hidden;
  $('profDrop').hidden=true;
};
App.ui.toggleProf=function(){
  $('profDrop').hidden=!$('profDrop').hidden;
  $('notiDrop').hidden=true;
};
App.ui.clearNoti=function(){
  $('notiList').innerHTML='<p class="noti-empty">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</p>';
  $('hBadge').hidden=true;
};
App.ui.confirm=function(msg){
  return new Promise(res=>{
    $('cfMsg').textContent=msg;$('mCf').hidden=false;
    const ok=$('cfOk');
    const handler=()=>{ok.removeEventListener('click',handler);$('mCf').hidden=true;res(true);};
    ok.addEventListener('click',handler);
  });
};

/* close dropdowns on outside click */
document.addEventListener('click',e=>{
  if(!e.target.closest('#hNoti')&&!e.target.closest('#notiDrop'))$('notiDrop').hidden=true;
  if(!e.target.closest('.hd-prof')&&!e.target.closest('#profDrop'))$('profDrop').hidden=true;
});

/* search shortcut */
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();$('hSearch').focus();}});

/* food chip selection */
document.addEventListener('click',e=>{
  const fc=e.target.closest('.food-chip');
  if(fc){fc.classList.toggle('food-chip--on');}
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROUTING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.rt.go=function(pg){
  S.pg=pg;
  /* pages */
  document.querySelectorAll('.pg').forEach(el=>el.classList.remove('pg--on'));
  const target=$('pg'+pg.charAt(0).toUpperCase()+pg.slice(1));
  if(target)target.classList.add('pg--on');

  /* sidebar links with flash animation */
  document.querySelectorAll('.sb-lk').forEach(lk=>{
    const wasOn=lk.classList.contains('sb-lk--on');
    const shouldBeOn=lk.dataset.pg===pg;
    lk.classList.toggle('sb-lk--on',shouldBeOn);
    if(!wasOn&&shouldBeOn){
      lk.style.animation='none';
      void lk.offsetWidth;
      lk.style.animation='menuFlash .4s ease-out';
    }
  });

  /* close mobile sidebar */
  $('sb').classList.remove('sb--open');$('sbOv').hidden=true;

  /* load data */
  if(pg==='dash')App.dash.render();
  else if(pg==='notices')App.notice.load();
  else if(pg==='dining'){App.din.init();App.dl.load();}
  else if(pg==='calendar')App.cal.show();
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.dash.render=async function(){
  if(!S.user)return;
  const uid=S.user.uid;
  try{
    /* notices count */
    const nSnap=await db.collection('users').doc(uid).collection('notices').orderBy('created','desc').limit(5).get();
    $('dsNotice').textContent=nSnap.size;
    let nHTML='';
    if(nSnap.empty){nHTML='<p class="empty-msg">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p>';}
    else{nSnap.forEach(d=>{const v=d.data();nHTML+=`<div class="dash-item"><span class="pri-dot pri-dot--${v.priority||'normal'}"></span><span class="dash-item-title">${esc(v.title||'')}</span><span class="dash-item-time">${tAgo(v.created)}</span></div>`;});}
    $('dashNotices').innerHTML=nHTML;

    /* dining log */
    const dlSnap=await db.collection('users').doc(uid).collection('dining_log').orderBy('date','desc').limit(5).get();
    $('dsDining').textContent=dlSnap.size;
    let totalCost=0,dlHTML='';
    if(dlSnap.empty){dlHTML='<p class="empty-msg">íšŒì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';}
    else{dlSnap.forEach(d=>{const v=d.data();totalCost+=Number(v.cost||0);dlHTML+=`<div class="dash-item"><span>ğŸ½ï¸</span><span class="dash-item-title">${esc(v.name||'')}</span><span class="dash-item-time">${v.date||''}</span></div>`;});}
    $('dashDining').innerHTML=dlHTML;
    $('dsCost').textContent=fMoney(totalCost);

    /* calendar events */
    if(S.calLinked&&_gapiOk){
      try{
        const resp=await gapi.client.calendar.events.list({calendarId:'primary',timeMin:now().toISOString(),maxResults:5,singleEvents:true,orderBy:'startTime'});
        const items=resp.result.items||[];
        $('dsEvent').textContent=items.length;
        let evHTML='';
        if(!items.length){evHTML='<p class="empty-msg">ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>';}
        else{items.forEach(ev=>{const dt=ev.start.dateTime||ev.start.date;evHTML+=`<div class="dash-item"><span>ğŸ“…</span><span class="dash-item-title">${esc(ev.summary||'(ì œëª© ì—†ìŒ)')}</span><span class="dash-item-time">${new Date(dt).toLocaleDateString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})}</span></div>`;});}
        $('dashEvents').innerHTML=evHTML;
      }catch(e){$('dashEvents').innerHTML='<p class="empty-msg">ìº˜ë¦°ë”ë¥¼ ì—°ë™í•˜ë©´ ì¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤</p>';}
    }else{
      $('dsEvent').textContent='-';
      $('dashEvents').innerHTML='<p class="empty-msg">ìº˜ë¦°ë”ë¥¼ ì—°ë™í•˜ë©´ ì¼ì •ì´ í‘œì‹œë©ë‹ˆë‹¤</p>';
    }
  }catch(e){console.error('dash error',e);toast('ëŒ€ì‹œë³´ë“œ ë¡œë”© ì˜¤ë¥˜','error');}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTICES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.notice.load=async function(){
  if(!S.user)return;
  try{
    const snap=await db.collection('users').doc(S.user.uid).collection('notices').orderBy('created','desc').get();
    S.notices=[];snap.forEach(d=>S.notices.push({id:d.id,...d.data()}));
    App.notice.render();
  }catch(e){toast('ê³µì§€ ë¡œë”© ì˜¤ë¥˜','error');}
};
App.notice.render=function(){
  const list=S.nFilter==='all'?S.notices:S.notices.filter(n=>n.priority===S.nFilter);
  if(!list.length){$('noticeList').innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#cbd5e1" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  let h='';
  list.forEach(n=>{
    const priLabel={normal:'ì¼ë°˜',important:'ì¤‘ìš”',urgent:'ê¸´ê¸‰'}[n.priority||'normal'];
    h+=`<div class="notice-card" onclick="App.notice.open('${n.id}')">
      <div class="notice-top"><span class="pri-tag pri-tag--${n.priority||'normal'}">${priLabel}</span><span class="notice-time">${tAgo(n.created)}</span></div>
      <h4 class="notice-title">${esc(n.title||'')}</h4>
      <p class="notice-body">${esc((n.body||'').substring(0,120))}${(n.body||'').length>120?'â€¦':''}</p>
    </div>`;
  });
  $('noticeList').innerHTML=h;
};
App.notice.filter=function(f){
  S.nFilter=f;
  document.querySelectorAll('[data-nf]').forEach(el=>el.classList.toggle('chip--on',el.dataset.nf===f));
  App.notice.render();
};
App.notice.openNew=function(){
  S.editNoticeId=null;$('mNTitle').textContent='ìƒˆ ê³µì§€';
  $('nTitle').value='';$('nBody').value='';$('nPri').value='normal';
  $('mN').hidden=false;$('nTitle').focus();
};
App.notice.open=function(id){
  const n=S.notices.find(x=>x.id===id);if(!n)return;
  S.editNoticeId=id;$('mNTitle').textContent='ê³µì§€ ìˆ˜ì •';
  $('nTitle').value=n.title||'';$('nBody').value=n.body||'';$('nPri').value=n.priority||'normal';
  $('mN').hidden=false;
};
App.notice.save=async function(){
  const title=$('nTitle').value.trim(),body=$('nBody').value.trim(),pri=$('nPri').value;
  if(!title){toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const btn=$('nSaveBtn');btn.disabled=true;btn.textContent='ì €ì¥ ì¤‘...';
  try{
    const col=db.collection('users').doc(S.user.uid).collection('notices');
    const data={title,body,priority:pri,updated:firebase.firestore.FieldValue.serverTimestamp()};
    if(S.editNoticeId){await col.doc(S.editNoticeId).update(data);toast('ê³µì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success');}
    else{data.created=firebase.firestore.FieldValue.serverTimestamp();await col.add(data);toast('ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤','success');}
    $('mN').hidden=true;App.notice.load();
  }catch(e){toast('ì €ì¥ ì˜¤ë¥˜','error');}
  finally{btn.disabled=false;btn.textContent='ì €ì¥';}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DINING FINDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.din.init=function(){/* food grid already handled by event delegation */};
App.din.search=function(){
  const area=$('dinArea').value;
  const ppl=$('dinPpl').value;
  const foods=[...document.querySelectorAll('.food-chip--on')].map(el=>el.dataset.food);
  if(!area){toast('ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”','error');return;}
  if(!foods.length){toast('ìŒì‹ ì¢…ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return;}

  const q=area+' '+foods.join(' ')+' ë§›ì§‘'+(ppl?' '+ppl:'');
  const mapUrl='https://map.naver.com/v5/search/'+encodeURIComponent(q);

  $('dinResult').hidden=false;
  const container=$('dinMap');
  container.innerHTML='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:1rem;"><div class="spinner"></div><p>ì§€ë„ ë¡œë”© ì¤‘...</p></div>';

  const iframe=document.createElement('iframe');
  iframe.src=mapUrl;
  iframe.style.cssText='width:100%;height:100%;border:none;';
  iframe.setAttribute('loading','lazy');
  iframe.setAttribute('referrerpolicy','no-referrer');

  iframe.onload=function(){container.innerHTML='';container.appendChild(iframe);};
  iframe.onerror=function(){_dinFallback(mapUrl,container);};

  /* fallback timeout */
  setTimeout(()=>{
    if(!container.contains(iframe)){_dinFallback(mapUrl,container);}
  },5000);

  /* start loading */
  container.appendChild(iframe);

  toast('ğŸ½ï¸ "'+q+'" ê²€ìƒ‰ ì¤‘...','info');
};

function _dinFallback(url,container){
  container.innerHTML=`<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:1rem;text-align:center;padding:2rem;">
    <svg viewBox="0 0 24 24" width="48" height="48" fill="none" stroke="#6366f1" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 12l2 2 4-4"/></svg>
    <p>iframeì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
    <a href="${url}" target="_blank" rel="noopener" class="btn btn--primary">ë„¤ì´ë²„ ì§€ë„ì—ì„œ ì—´ê¸° â†—</a>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DINING LOG
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.dl.load=async function(){
  if(!S.user)return;
  try{
    const snap=await db.collection('users').doc(S.user.uid).collection('dining_log').orderBy('date','desc').get();
    S.dlList=[];snap.forEach(d=>S.dlList.push({id:d.id,...d.data()}));
    App.dl.render();
  }catch(e){toast('íšŒì‹ ê¸°ë¡ ë¡œë”© ì˜¤ë¥˜','error');}
};
App.dl.render=function(){
  /* stats */
  const total=S.dlList.reduce((a,d)=>a+Number(d.cost||0),0);
  const avg=S.dlList.length?Math.round(total/S.dlList.length):0;
  $('dlStats').innerHTML=`<div class="dl-stat-item"><strong>${S.dlList.length}</strong>ê±´</div><div class="dl-stat-item">ì´ <strong>${fMoney(total)}</strong></div><div class="dl-stat-item">í‰ê·  <strong>${fMoney(avg)}</strong></div>`;

  if(!S.dlList.length){$('dlList').innerHTML='<p class="empty-msg">íšŒì‹ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';return;}
  let h='';
  S.dlList.forEach(d=>{
    const stars='â­'.repeat(Number(d.rating||0));
    h+=`<div class="dl-card" onclick="App.dl.open('${d.id}')">
      <div class="dl-top"><strong>${esc(d.name||'')}</strong><span class="dl-date">${d.date||''}</span></div>
      <div class="dl-meta">${esc(d.area||'')} Â· ${esc(d.food||'')} Â· ${d.people||'?'}ëª…</div>
      <div class="dl-bottom"><span>${stars}</span><span class="dl-cost">${fMoney(d.cost)}</span></div>
      ${d.memo?'<div class="dl-memo">'+esc(d.memo)+'</div>':''}
    </div>`;
  });
  $('dlList').innerHTML=h;
};
App.dl.openNew=function(){
  S.editDlId=null;$('mDLTitle').textContent='íšŒì‹ ê¸°ë¡ ì¶”ê°€';
  $('dlName').value='';$('dlArea').value='';$('dlFood').value='';$('dlPpl').value='';
  $('dlCost').value='';$('dlDate').value=toLocalDT(now()).split('T')[0];$('dlRate').value='5';$('dlMemo').value='';
  $('dlDelBtn').hidden=true;$('mDL').hidden=false;$('dlName').focus();
};
App.dl.open=function(id){
  const d=S.dlList.find(x=>x.id===id);if(!d)return;
  S.editDlId=id;$('mDLTitle').textContent='íšŒì‹ ê¸°ë¡ ìˆ˜ì •';
  $('dlName').value=d.name||'';$('dlArea').value=d.area||'';$('dlFood').value=d.food||'';
  $('dlPpl').value=d.people||'';$('dlCost').value=d.cost||'';$('dlDate').value=d.date||'';
  $('dlRate').value=d.rating||'5';$('dlMemo').value=d.memo||'';
  $('dlDelBtn').hidden=false;$('mDL').hidden=false;
};
App.dl.save=async function(){
  const name=$('dlName').value.trim();
  if(!name){toast('ì‹ë‹¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const data={name,area:$('dlArea').value.trim(),food:$('dlFood').value.trim(),people:Number($('dlPpl').value)||0,cost:Number($('dlCost').value)||0,date:$('dlDate').value,rating:Number($('dlRate').value),memo:$('dlMemo').value.trim(),updated:firebase.firestore.FieldValue.serverTimestamp()};
  try{
    const col=db.collection('users').doc(S.user.uid).collection('dining_log');
    if(S.editDlId){await col.doc(S.editDlId).update(data);toast('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success');}
    else{data.created=firebase.firestore.FieldValue.serverTimestamp();await col.add(data);toast('ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤','success');}
    $('mDL').hidden=true;App.dl.load();
  }catch(e){toast('ì €ì¥ ì˜¤ë¥˜','error');}
};
App.dl.del=async function(){
  if(!S.editDlId)return;
  if(!await App.ui.confirm('ì´ íšŒì‹ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    await db.collection('users').doc(S.user.uid).collection('dining_log').doc(S.editDlId).delete();
    toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');$('mDL').hidden=true;App.dl.load();
  }catch(e){toast('ì‚­ì œ ì˜¤ë¥˜','error');}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOOGLE CALENDAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.cal.show=function(){
  if(S.calLinked){
    $('calAuth').hidden=true;$('calUI').hidden=false;
    App.cal.render();App.cal.fetchEvents();
  }else{
    $('calAuth').hidden=false;$('calUI').hidden=true;
  }
};
App.cal.authorize=function(){
  if(!_gisOk){toast('Google ë¡œê·¸ì¸ ì„œë¹„ìŠ¤ ë¡œë”© ì¤‘...','error');return;}
  _tokClient.requestAccessToken({prompt:'consent'});
};
App.cal._onToken=function(resp){
  if(resp.error){toast('ìº˜ë¦°ë” ê¶Œí•œ ê±°ë¶€ë¨','error');return;}
  sessionStorage.setItem('gcal_tok',resp.access_token);
  S.calLinked=true;
  toast('Google ìº˜ë¦°ë”ê°€ ì—°ë™ë˜ì—ˆìŠµë‹ˆë‹¤!','success');
  App.cal.show();
};
App.cal.render=function(){
  const y=S.calYear,m=S.calMonth;
  $('calMonth').textContent=y+'ë…„ '+(m+1)+'ì›”';
  const first=new Date(y,m,1),last=new Date(y,m+1,0);
  const startDay=first.getDay(),totalDays=last.getDate();
  let h='<div class="cal-head">ì¼</div><div class="cal-head">ì›”</div><div class="cal-head">í™”</div><div class="cal-head">ìˆ˜</div><div class="cal-head">ëª©</div><div class="cal-head">ê¸ˆ</div><div class="cal-head">í† </div>';
  for(let i=0;i<startDay;i++)h+='<div class="cal-cell cal-cell--empty"></div>';
  const today=now();
  for(let d=1;d<=totalDays;d++){
    const ds=y+'-'+pad2(m+1)+'-'+pad2(d);
    const isToday=d===today.getDate()&&m===today.getMonth()&&y===today.getFullYear();
    const evts=S.calEvents.filter(e=>(e.start.dateTime||e.start.date||'').startsWith(ds));
    h+=`<div class="cal-cell${isToday?' cal-cell--today':''}" onclick="App.cal.openNewOnDate('${ds}')">
      <span class="cal-day">${d}</span>`;
    evts.slice(0,3).forEach(e=>{h+=`<div class="cal-evt" title="${esc(e.summary||'')}" onclick="event.stopPropagation();App.cal.editEvent('${e.id}')">${esc((e.summary||'').substring(0,8))}</div>`;});
    if(evts.length>3)h+=`<div class="cal-more">+${evts.length-3}ê°œ</div>`;
    h+='</div>';
  }
  $('calGrid').innerHTML=h;
};
App.cal.fetchEvents=async function(){
  if(!S.calLinked||!_gapiOk)return;
  try{
    const tMin=new Date(S.calYear,S.calMonth,1).toISOString();
    const tMax=new Date(S.calYear,S.calMonth+1,0,23,59,59).toISOString();
    const resp=await gapi.client.calendar.events.list({calendarId:'primary',timeMin:tMin,timeMax:tMax,singleEvents:true,orderBy:'startTime',maxResults:200});
    S.calEvents=resp.result.items||[];
    App.cal.render();
    App.cal.renderUpcoming();
  }catch(e){
    console.error('fetchEvents error',e);
    if(e.status===401||e.status===403){S.calLinked=false;sessionStorage.removeItem('gcal_tok');App.cal.show();toast('ìº˜ë¦°ë” ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ë™í•´ì£¼ì„¸ìš”.','error');}
  }
};
App.cal.renderUpcoming=function(){
  const upcoming=S.calEvents.filter(e=>{const d=new Date(e.start.dateTime||e.start.date);return d>=now();}).slice(0,8);
  if(!upcoming.length){$('calUpcoming').innerHTML='<p class="empty-msg">ì´ë²ˆ ë‹¬ ë‚¨ì€ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</p>';return;}
  let h='';
  upcoming.forEach(e=>{
    const dt=new Date(e.start.dateTime||e.start.date);
    h+=`<div class="dash-item" style="cursor:pointer" onclick="App.cal.editEvent('${e.id}')">
      <span>ğŸ“…</span>
      <span class="dash-item-title">${esc(e.summary||'(ì œëª© ì—†ìŒ)')}</span>
      <span class="dash-item-time">${dt.toLocaleDateString('ko-KR',{month:'short',day:'numeric'})} ${e.start.dateTime?dt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):''}</span>
    </div>`;
  });
  $('calUpcoming').innerHTML=h;
};
App.cal.prev=function(){S.calMonth--;if(S.calMonth<0){S.calMonth=11;S.calYear--;}App.cal.render();App.cal.fetchEvents();};
App.cal.next=function(){S.calMonth++;if(S.calMonth>11){S.calMonth=0;S.calYear++;}App.cal.render();App.cal.fetchEvents();};
App.cal.today=function(){const t=now();S.calYear=t.getFullYear();S.calMonth=t.getMonth();App.cal.render();App.cal.fetchEvents();};

App.cal.openNew=function(){
  if(!S.calLinked){toast('ë¨¼ì € Google ìº˜ë¦°ë”ë¥¼ ì—°ë™í•˜ì„¸ìš”','error');return;}
  S.editEvtId=null;$('mCETitle').textContent='ì¼ì • ì¶”ê°€';
  const n=now();n.setHours(n.getHours()+1,0,0,0);
  const e=new Date(n.getTime()+3600000);
  $('ceTitle').value='';$('ceStart').value=toLocalDT(n);$('ceEnd').value=toLocalDT(e);
  $('ceLoc').value='';$('ceDesc').value='';$('ceRemind').value='30';
  $('ceDelBtn').hidden=true;$('mCE').hidden=false;$('ceTitle').focus();
};
App.cal.openNewOnDate=function(ds){
  if(!S.calLinked){toast('ë¨¼ì € Google ìº˜ë¦°ë”ë¥¼ ì—°ë™í•˜ì„¸ìš”','error');return;}
  S.editEvtId=null;$('mCETitle').textContent='ì¼ì • ì¶”ê°€';
  $('ceTitle').value='';$('ceStart').value=ds+'T09:00';$('ceEnd').value=ds+'T10:00';
  $('ceLoc').value='';$('ceDesc').value='';$('ceRemind').value='30';
  $('ceDelBtn').hidden=true;$('mCE').hidden=false;$('ceTitle').focus();
};
App.cal.editEvent=function(id){
  const ev=S.calEvents.find(e=>e.id===id);if(!ev)return;
  S.editEvtId=id;$('mCETitle').textContent='ì¼ì • ìˆ˜ì •';
  $('ceTitle').value=ev.summary||'';
  $('ceStart').value=ev.start.dateTime?toLocalDT(new Date(ev.start.dateTime)):ev.start.date+'T09:00';
  $('ceEnd').value=ev.end.dateTime?toLocalDT(new Date(ev.end.dateTime)):ev.end.date+'T10:00';
  $('ceLoc').value=ev.location||'';$('ceDesc').value=ev.description||'';
  const rem=ev.reminders?.overrides?.[0]?.minutes;
  $('ceRemind').value=rem!==undefined?String(rem):'30';
  $('ceDelBtn').hidden=false;$('mCE').hidden=false;
};
App.cal.saveEvent=async function(){
  const title=$('ceTitle').value.trim();
  if(!title){toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const body={
    summary:title,
    start:{dateTime:new Date($('ceStart').value).toISOString(),timeZone:'Asia/Seoul'},
    end:{dateTime:new Date($('ceEnd').value).toISOString(),timeZone:'Asia/Seoul'},
    location:$('ceLoc').value.trim()||undefined,
    description:$('ceDesc').value.trim()||undefined
  };
  const remVal=$('ceRemind').value;
  if(remVal){body.reminders={useDefault:false,overrides:[{method:'popup',minutes:Number(remVal)}]};}
  else{body.reminders={useDefault:false,overrides:[]};}

  try{
    if(S.editEvtId){
      await gapi.client.calendar.events.update({calendarId:'primary',eventId:S.editEvtId,resource:body});
      toast('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤','success');
    }else{
      await gapi.client.calendar.events.insert({calendarId:'primary',resource:body});
      toast('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤','success');
    }
    $('mCE').hidden=true;App.cal.fetchEvents();
  }catch(e){console.error('save event error',e);toast('ì¼ì • ì €ì¥ ì˜¤ë¥˜','error');}
};
App.cal.deleteEvent=async function(){
  if(!S.editEvtId)return;
  if(!await App.ui.confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    await gapi.client.calendar.events.delete({calendarId:'primary',eventId:S.editEvtId});
    toast('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');$('mCE').hidden=true;App.cal.fetchEvents();
  }catch(e){toast('ì‚­ì œ ì˜¤ë¥˜','error');}
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAPI / GIS INIT  (polling-based)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function _initGapi(){
  if(typeof gapi==='undefined'||!gapi.load)return false;
  gapi.load('client',async()=>{
    try{
      await gapi.client.init({apiKey:GCAL_KEY,discoveryDocs:[GCAL_DISC]});
      _gapiOk=true;console.log('[WorkHub] GAPI ready');
      _tryAutoLink();
    }catch(e){console.error('GAPI init error',e);}
  });
  return true;
}
function _initGis(){
  if(typeof google==='undefined'||!google.accounts||!google.accounts.oauth2)return false;
  _tokClient=google.accounts.oauth2.initTokenClient({
    client_id:GCAL_CID,scope:GCAL_SCOPE,
    callback:resp=>App.cal._onToken(resp)
  });
  _gisOk=true;console.log('[WorkHub] GIS ready');
  _tryAutoLink();
  return true;
}
function _tryAutoLink(){
  if(!_gapiOk||!_gisOk)return;
  const tok=sessionStorage.getItem('gcal_tok');
  if(tok){gapi.client.setToken({access_token:tok});S.calLinked=true;}
  if(S.calLinked&&S.pg==='calendar')App.cal.show();
}
(function _poll(){
  let a=0;
  const t=setInterval(()=>{
    a++;
    if(!_gapiOk)_initGapi();
    if(!_gisOk)_initGis();
    if((_gapiOk&&_gisOk)||a>50)clearInterval(t);
  },200);
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHATBOT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
App.chat.toggle=function(){
  S.chatOpen=!S.chatOpen;
  $('chatPanel').hidden=!S.chatOpen;
  if(S.chatOpen)$('chatIn').focus();
};
App.chat.addMsg=function(text,who){
  const msgs=$('chatMsgs'),d=document.createElement('div');
  d.className='chat-msg chat-msg--'+who;
  d.innerHTML='<div class="chat-bubble">'+text+'</div>';
  msgs.appendChild(d);msgs.scrollTop=msgs.scrollHeight;
};
App.chat.send=async function(){
  const inp=$('chatIn'),txt=inp.value.trim();if(!txt)return;
  inp.value='';App.chat.addMsg(esc(txt),'user');

  /* step-based flow */
  if(S.chatStep){App.chat.handleStep(txt);return;}

  const low=txt.toLowerCase();

  /* nav commands */
  if(/ëŒ€ì‹œë³´ë“œ/.test(low)){App.rt.go('dash');App.chat.addMsg('ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤!','bot');return;}
  if(/ê³µì§€.*ëª©ë¡|ê³µì§€ì‚¬í•­/.test(low)){App.rt.go('notices');App.chat.addMsg('ê³µì§€ì‚¬í•­ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!','bot');return;}
  if(/ìº˜ë¦°ë”|ì¼ì •.*ê´€ë¦¬/.test(low)&&!/ë“±ë¡|ì¶”ê°€|ì˜¤ëŠ˜|ë‚´ì¼/.test(low)){App.rt.go('calendar');App.chat.addMsg('ìº˜ë¦°ë” í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!','bot');return;}
  if(/íšŒì‹/.test(low)&&!/ê²€ìƒ‰/.test(low)){App.rt.go('dining');App.chat.addMsg('íšŒì‹ ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤!','bot');return;}

  /* today/tomorrow events */
  if(/ì˜¤ëŠ˜.*ì¼ì •/.test(low)){App.chat._showDayEvents(0);return;}
  if(/ë‚´ì¼.*ì¼ì •/.test(low)){App.chat._showDayEvents(1);return;}

  /* schedule registration */
  if(/ì¼ì •.*(ë“±ë¡|ì¶”ê°€|ë§Œë“¤|ìƒì„±)/.test(low)){
    /* try inline parsing: "ì¼ì • ë“±ë¡ 3ì›” 5ì¼ 14ì‹œ íšŒì˜" */
    const parsed=App.chat._parseInline(txt);
    if(parsed){App.chat._createQuickEvent(parsed);return;}
    S.chatStep='evt_title';S.chatBuf={};
    App.chat.addMsg('ì¼ì • ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','bot');return;
  }

  /* notice creation */
  if(/ê³µì§€.*ì‘ì„±|ê³µì§€.*ë“±ë¡/.test(low)){
    S.chatStep='n_title';S.chatBuf={};
    App.chat.addMsg('ê³µì§€ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','bot');return;
  }

  /* dining search */
  if(/íšŒì‹.*ê²€ìƒ‰|ë§›ì§‘.*ê²€ìƒ‰/.test(low)){
    const parts=txt.replace(/íšŒì‹|ë§›ì§‘|ê²€ìƒ‰/g,'').trim().split(/\s+/);
    if(parts.length>=2){
      $('dinArea').value=parts[0]||'';
      document.querySelectorAll('.food-chip--on').forEach(el=>el.classList.remove('food-chip--on'));
      const fc=[...document.querySelectorAll('.food-chip')].find(el=>el.dataset.food.includes(parts[1]));
      if(fc)fc.classList.add('food-chip--on');
      App.rt.go('dining');App.din.search();
      App.chat.addMsg('ğŸ½ï¸ '+parts[0]+' '+parts[1]+' ë§›ì§‘ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤!','bot');
    }else{
      App.chat.addMsg('í˜•ì‹: "íšŒì‹ ê²€ìƒ‰ ê°•ë‚¨ í•œì‹"','bot');
    }
    return;
  }

  /* fallback */
  App.chat.addMsg('ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´:<br>â€¢ "ì˜¤ëŠ˜ ì¼ì •" / "ë‚´ì¼ ì¼ì •"<br>â€¢ "ì¼ì • ë“±ë¡"<br>â€¢ "ê³µì§€ ì‘ì„±" / "ê³µì§€ ëª©ë¡"<br>â€¢ "íšŒì‹ ê²€ìƒ‰ [ì§€ì—­] [ìŒì‹]"<br>â€¢ "ëŒ€ì‹œë³´ë“œ" / "ìº˜ë¦°ë” ì—´ì–´"','bot');
};

App.chat.handleStep=function(txt){
  const step=S.chatStep,buf=S.chatBuf;
  if(step==='evt_title'){buf.title=txt;S.chatStep='evt_date';App.chat.addMsg('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 2026-03-05 ë˜ëŠ” 3ì›” 5ì¼)','bot');return;}
  if(step==='evt_date'){buf.date=App.chat._parseDate(txt);S.chatStep='evt_time';App.chat.addMsg('ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 14:00 ë˜ëŠ” ì˜¤í›„ 2ì‹œ)','bot');return;}
  if(step==='evt_time'){buf.time=App.chat._parseTime(txt);S.chatStep=null;App.chat._createQuickEvent(buf);return;}
  if(step==='n_title'){buf.title=txt;S.chatStep='n_body';App.chat.addMsg('ê³µì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.','bot');return;}
  if(step==='n_body'){buf.body=txt;S.chatStep='n_pri';App.chat.addMsg('ì¤‘ìš”ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”: ì¼ë°˜ / ì¤‘ìš” / ê¸´ê¸‰','bot');return;}
  if(step==='n_pri'){
    let pri='normal';if(/ì¤‘ìš”/.test(txt))pri='important';if(/ê¸´ê¸‰/.test(txt))pri='urgent';
    S.chatStep=null;
    App.chat._createNotice(buf.title,buf.body,pri);return;
  }
};

App.chat._showDayEvents=function(offset){
  if(!S.calLinked){App.chat.addMsg('ìº˜ë¦°ë”ë¥¼ ë¨¼ì € ì—°ë™í•´ì£¼ì„¸ìš”. ìº˜ë¦°ë” í˜ì´ì§€ì—ì„œ ì—°ë™ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.','bot');return;}
  const d=now();d.setDate(d.getDate()+offset);
  const ds=d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());
  const label=offset===0?'ì˜¤ëŠ˜':'ë‚´ì¼';

  gapi.client.calendar.events.list({
    calendarId:'primary',
    timeMin:new Date(d.getFullYear(),d.getMonth(),d.getDate()).toISOString(),
    timeMax:new Date(d.getFullYear(),d.getMonth(),d.getDate(),23,59,59).toISOString(),
    singleEvents:true,orderBy:'startTime'
  }).then(resp=>{
    const items=resp.result.items||[];
    if(!items.length){App.chat.addMsg('ğŸ“… '+label+' ('+ds+') ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.','bot');return;}
    let h='ğŸ“… <b>'+label+' ì¼ì •</b> ('+ds+'):<br>';
    items.forEach((e,i)=>{
      const t=e.start.dateTime?new Date(e.start.dateTime).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'ì¢…ì¼';
      h+=(i+1)+'. '+t+' - '+esc(e.summary||'(ì œëª© ì—†ìŒ)')+'<br>';
    });
    App.chat.addMsg(h,'bot');
  }).catch(e=>{App.chat.addMsg('ì¼ì • ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.','bot');});
};

App.chat._parseInline=function(txt){
  /* "ì¼ì • ë“±ë¡ 3ì›” 5ì¼ 14ì‹œ íšŒì˜" */
  const m=txt.match(/(\d{1,2})ì›”\s*(\d{1,2})ì¼\s*(\d{1,2})ì‹œ?\s*(.*)/);
  if(!m)return null;
  const y=now().getFullYear();
  return{title:m[4].trim()||'ìƒˆ ì¼ì •',date:y+'-'+pad2(m[1])+'-'+pad2(m[2]),time:pad2(m[3])+':00'};
};
App.chat._parseDate=function(txt){
  const m1=txt.match(/(\d{4})-(\d{1,2})-(\d{1,2})/);
  if(m1)return m1[0];
  const m2=txt.match(/(\d{1,2})ì›”\s*(\d{1,2})ì¼/);
  if(m2)return now().getFullYear()+'-'+pad2(m2[1])+'-'+pad2(m2[2]);
  return toLocalDT(now()).split('T')[0];
};
App.chat._parseTime=function(txt){
  const m1=txt.match(/(\d{1,2}):(\d{2})/);if(m1)return pad2(m1[1])+':'+m1[2];
  const m2=txt.match(/ì˜¤í›„\s*(\d{1,2})ì‹œ/);if(m2)return pad2(Number(m2[1])+12)+':00';
  const m3=txt.match(/(\d{1,2})ì‹œ/);if(m3)return pad2(m3[1])+':00';
  return'09:00';
};
App.chat._createQuickEvent=async function(buf){
  if(!S.calLinked){App.chat.addMsg('ìº˜ë¦°ë”ë¥¼ ë¨¼ì € ì—°ë™í•´ì£¼ì„¸ìš”.','bot');return;}
  const start=new Date(buf.date+'T'+buf.time);
  const end=new Date(start.getTime()+3600000);
  try{
    await gapi.client.calendar.events.insert({calendarId:'primary',resource:{
      summary:buf.title,
      start:{dateTime:start.toISOString(),timeZone:'Asia/Seoul'},
      end:{dateTime:end.toISOString(),timeZone:'Asia/Seoul'}
    }});
    App.chat.addMsg('âœ… ì¼ì • ë“±ë¡ ì™„ë£Œ!<br>ğŸ“Œ '+esc(buf.title)+'<br>ğŸ“… '+buf.date+' '+buf.time,'bot');
    if(S.pg==='calendar')App.cal.fetchEvents();
  }catch(e){App.chat.addMsg('ì¼ì • ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.','bot');}
};
App.chat._createNotice=async function(title,body,pri){
  try{
    await db.collection('users').doc(S.user.uid).collection('notices').add({
      title,body,priority:pri,created:firebase.firestore.FieldValue.serverTimestamp()
    });
    const priLabel={normal:'ì¼ë°˜',important:'ì¤‘ìš”',urgent:'ê¸´ê¸‰'}[pri];
    App.chat.addMsg('âœ… ê³µì§€ ë“±ë¡ ì™„ë£Œ!<br>ğŸ“Œ '+esc(title)+'<br>ì¤‘ìš”ë„: '+priLabel,'bot');
    if(S.pg==='notices')App.notice.load();
  }catch(e){App.chat.addMsg('ê³µì§€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.','bot');}
};
</script>
</body>
</html>
